import{u as me,b as pe,a as xe,j as e,d as S}from"./index-Ds4hQBUW.js";import{r as o,ai as d,J as L,B as h,ay as ye,T as he,j as g,n as ge,au as P,aU as je,aV as F,$ as Se,a7 as fe,an as k,Q as De,aA as ve,d as m,C as n,i as j,S as I,e as we,a as A,aO as z,v as q,af as be,l as B,f as V,aP as Ce,q as O,t as Q,aN as Te,V as Ie,M as Ee,Y as W,W as Ne}from"./antd-Beg1odhe.js";import"./vendor-DJG_os-6.js";const{Title:Re,Text:c,Paragraph:Y}=he,{Search:$e}=be,{Option:r}=B,Le=S.div`
  padding: 24px;
`,ke=S.div`
  margin-bottom: 24px;
`,ze=S.div`
  margin-bottom: 24px;
  padding: 16px;
  background: var(--card-bg);
  border-radius: 8px;
  border: 1px solid var(--border-color);
`,Be=S.div`
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
  gap: 16px;
`,_e=S(j)`
  border-radius: 8px;
  cursor: pointer;

  &:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
  }

  .ant-card-head {
    border-bottom: 1px solid var(--border-color);
    padding: 12px 16px;
  }

  .ant-card-body {
    padding: 16px;
  }
`,Me=S.div`
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: 32px;
  height: 32px;
  border-radius: 6px;
  color: white;
  font-size: 16px;
  margin-right: 8px;
`,qe=()=>{const{t:s}=me(["entityScan","common"]),G=pe(),{dataSourceId:w}=xe(),[x,H]=o.useState(null),[i,f]=o.useState(null),[p,_]=o.useState([]),[Ke,b]=o.useState(!1),[J,D]=o.useState(!1),[v,U]=o.useState([]),[C,X]=o.useState(""),[E,Z]=o.useState("all"),[N,ee]=o.useState("all"),te=(t,a)=>{switch(t){case"database":return e.jsx(V,{});case"api":return e.jsx(O,{});case"cloud":return e.jsx(Ce,{});default:return e.jsx(V,{})}},R=t=>({table:{icon:e.jsx(z,{}),color:"#1890ff",name:s("entityScan:scanDetail.entityTypes.table")},view:{icon:e.jsx(q,{}),color:"#52c41a",name:s("entityScan:scanDetail.entityTypes.view")},procedure:{icon:e.jsx(Ne,{}),color:"#722ed1",name:s("entityScan:scanDetail.entityTypes.procedure")},function:{icon:e.jsx(W,{}),color:"#fa8c16",name:s("entityScan:scanDetail.entityTypes.function")},api:{icon:e.jsx(O,{}),color:"#13c2c2",name:s("entityScan:scanDetail.entityTypes.api")},file:{icon:e.jsx(W,{}),color:"#eb2f96",name:s("entityScan:scanDetail.entityTypes.file")}})[t]||{icon:e.jsx(z,{}),color:"#8c8c8c",name:t},M=t=>{const a={running:{text:s("entityScan:scanDetail.scanStatus.scanning"),color:"processing",icon:e.jsx(F,{spin:!0})},completed:{text:s("entityScan:scanDetail.scanStatus.completed"),color:"success",icon:e.jsx(A,{})},failed:{text:s("entityScan:scanDetail.scanStatus.failed"),color:"error",icon:e.jsx(Ie,{})},paused:{text:s("entityScan:scanDetail.scanStatus.paused"),color:"warning",icon:e.jsx(P,{})}};return a[t]||a.completed};o.useEffect(()=>{w&&(se(),K())},[w]);const se=async()=>{try{b(!0);const t={id:w,name:"MySQL生产数据库",type:"database",subType:"mysql",description:"电商系统核心业务数据库，包含用户、订单、商品等核心业务表",host:"mysql-prod.example.com",port:3306,database:"ecommerce_db",username:"scan_user",status:"connected",lastConnected:new Date().toLocaleString(),scanCount:15};H(t);const a={id:"scan_"+Date.now(),dataSourceId:w,dataSourceName:t.name,status:"completed",progress:100,startTime:new Date(Date.now()-3e5).toLocaleString(),endTime:new Date().toLocaleString(),entityCount:12,errorCount:0,selectedCount:8};f(a)}catch{d.error(s("entityScan:scanDetail.messages.loadDataSourceFailed"))}finally{b(!1)}},K=async()=>{try{b(!0);const t=[{id:"1",name:"users",type:"table",schema:"ecommerce_db",description:"用户基础信息表",selected:!0,scanTime:new Date().toLocaleString(),recordCount:15e4,size:"25.6MB",status:"active",owner:"张三",tags:["核心业务","用户数据"],columns:[{name:"id",type:"bigint",nullable:!1,primaryKey:!0,description:"用户ID"},{name:"username",type:"varchar(50)",nullable:!1,primaryKey:!1,description:"用户名"},{name:"email",type:"varchar(100)",nullable:!1,primaryKey:!1,description:"邮箱"},{name:"created_at",type:"timestamp",nullable:!1,primaryKey:!1,description:"创建时间"}]},{id:"2",name:"orders",type:"table",schema:"ecommerce_db",description:"订单信息表",selected:!0,scanTime:new Date().toLocaleString(),recordCount:5e5,size:"120.3MB",status:"active",owner:"李四",tags:["核心业务","订单数据"],columns:[{name:"id",type:"bigint",nullable:!1,primaryKey:!0,description:"订单ID"},{name:"user_id",type:"bigint",nullable:!1,primaryKey:!1,foreignKey:"users.id",description:"用户ID"},{name:"total_amount",type:"decimal(10,2)",nullable:!1,primaryKey:!1,description:"订单总额"},{name:"status",type:"varchar(20)",nullable:!1,primaryKey:!1,description:"订单状态"}]},{id:"3",name:"products",type:"table",schema:"ecommerce_db",description:"商品信息表",selected:!0,scanTime:new Date().toLocaleString(),recordCount:5e4,size:"45.2MB",status:"active",owner:"王五",tags:["商品管理"],columns:[]},{id:"4",name:"user_order_view",type:"view",schema:"ecommerce_db",description:"用户订单视图",selected:!1,scanTime:new Date().toLocaleString(),status:"active",owner:"张三",tags:["视图","统计"],columns:[]},{id:"5",name:"get_user_stats",type:"procedure",schema:"ecommerce_db",description:"获取用户统计信息存储过程",selected:!1,scanTime:new Date().toLocaleString(),status:"active",owner:"李四",tags:["存储过程"],columns:[]}];_(t),U(t.filter(a=>a.selected).map(a=>a.id))}catch{d.error(s("entityScan:scanDetail.messages.loadScanResultsFailed"))}finally{b(!1)}},ae=async()=>{if(x)try{D(!0),f(a=>a?{...a,status:"running",progress:0,startTime:new Date().toLocaleString(),endTime:void 0}:null),d.loading(s("entityScan:scanDetail.messages.scanningDataSource"),2);const t=setInterval(()=>{f(a=>{if(!a||a.status!=="running")return clearInterval(t),a;const u=Math.min(a.progress+Math.random()*15,100);return u>=100?(clearInterval(t),D(!1),d.success(s("entityScan:scanDetail.messages.scanCompleted")),{...a,status:"completed",progress:100,endTime:new Date().toLocaleString(),entityCount:p.length,selectedCount:v.length}):{...a,progress:u}})},500)}catch{D(!1),d.error(s("entityScan:scanDetail.messages.scanFailed"))}},ne=()=>{D(!1),f(t=>t?{...t,status:"paused"}:null),d.info(s("entityScan:scanDetail.messages.scanPaused"))},ie=()=>{D(!1),f(t=>t?{...t,status:"completed",endTime:new Date().toLocaleString()}:null),d.info(s("entityScan:scanDetail.messages.scanStopped"))},ce=()=>{if(v.length===0){d.warning(s("entityScan:scanDetail.messages.selectEntitiesFirst"));return}const t=p.filter(a=>v.includes(a.id));console.log("导出数据:",t),d.success(s("entityScan:scanDetail.messages.exportSuccess",{count:t.length}))},re=t=>{Ee.info({title:`${s("entityScan:scanDetail.entityDetail.title")} - ${t.name}`,width:800,content:e.jsxs("div",{className:"entity-detail-modal",children:[e.jsxs(m,{gutter:[16,8],className:"entity-detail-row",children:[e.jsx(n,{span:6,children:e.jsxs("strong",{children:[s("entityScan:scanDetail.entityDetail.name"),":"]})}),e.jsx(n,{span:18,children:t.name})]}),e.jsxs(m,{gutter:[16,8],className:"entity-detail-row",children:[e.jsx(n,{span:6,children:e.jsxs("strong",{children:[s("entityScan:scanDetail.entityDetail.type"),":"]})}),e.jsx(n,{span:18,children:e.jsx(Q,{color:R(t.type).color,children:R(t.type).name})})]}),e.jsxs(m,{gutter:[16,8],className:"entity-detail-row",children:[e.jsx(n,{span:6,children:e.jsxs("strong",{children:[s("entityScan:scanDetail.entityDetail.schema"),":"]})}),e.jsx(n,{span:18,children:t.schema})]}),e.jsxs(m,{gutter:[16,8],className:"entity-detail-row",children:[e.jsx(n,{span:6,children:e.jsxs("strong",{children:[s("entityScan:scanDetail.entityDetail.description"),":"]})}),e.jsx(n,{span:18,children:t.description})]}),t.recordCount&&e.jsxs(m,{gutter:[16,8],className:"entity-detail-row",children:[e.jsx(n,{span:6,children:e.jsxs("strong",{children:[s("entityScan:scanDetail.entityDetail.recordCount"),":"]})}),e.jsx(n,{span:18,children:t.recordCount.toLocaleString()})]}),t.size&&e.jsxs(m,{gutter:[16,8],className:"entity-detail-row",children:[e.jsx(n,{span:6,children:e.jsxs("strong",{children:[s("entityScan:scanDetail.entityDetail.size"),":"]})}),e.jsx(n,{span:18,children:t.size})]}),e.jsxs(m,{gutter:[16,8],className:"entity-detail-row",children:[e.jsx(n,{span:6,children:e.jsxs("strong",{children:[s("entityScan:scanDetail.entityDetail.scanTime"),":"]})}),e.jsx(n,{span:18,children:t.scanTime})]})]})})},le=(t,a)=>{_(u=>u.map(l=>l.id===t?{...l,status:a?"active":"inactive"}:l)),d.success(s(a?"entityScan:scanDetail.messages.entityActivated":"entityScan:scanDetail.messages.entityDeactivated"))},oe=()=>i?{totalEntities:p.length,selectedEntities:v.length,tableCount:p.filter(t=>t.type==="table").length,viewCount:p.filter(t=>t.type==="view").length,activeCount:p.filter(t=>t.status==="active").length,warningCount:p.filter(t=>t.status==="warning").length}:{totalEntities:0,selectedEntities:0,tableCount:0,viewCount:0,activeCount:0,warningCount:0},de=()=>p.filter(t=>{var y;const a=!C||t.name.toLowerCase().includes(C.toLowerCase())||((y=t.description)==null?void 0:y.toLowerCase().includes(C.toLowerCase())),u=E==="all"||t.type===E,l=N==="all"||t.status===N;return a&&u&&l}),ue=t=>{var u;const a=R(t.type);return e.jsxs(_e,{size:"small",onClick:()=>re(t),title:e.jsxs(g,{children:[e.jsx(Me,{style:{backgroundColor:a.color},children:a.icon}),e.jsxs("div",{children:[e.jsx("div",{style:{fontWeight:"bold"},children:t.name}),e.jsxs(c,{type:"secondary",style:{fontSize:"12px"},children:[t.schema&&`${t.schema}.`,t.name]})]})]}),children:[e.jsx(Y,{ellipsis:{rows:2},style:{marginBottom:12},children:t.description||s("entityScan:scanDetail.entityCard.noDescription")}),e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:8},children:[e.jsxs(c,{type:"secondary",children:[s("entityScan:scanDetail.entityCard.owner"),":"]}),e.jsx(c,{children:t.owner||s("entityScan:scanDetail.entityCard.unspecified")})]}),t.recordCount&&e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:8},children:[e.jsxs(c,{type:"secondary",children:[s("entityScan:scanDetail.entityCard.recordCount"),":"]}),e.jsx(c,{children:t.recordCount.toLocaleString()})]}),t.size&&e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:8},children:[e.jsxs(c,{type:"secondary",children:[s("entityScan:scanDetail.entityCard.size"),":"]}),e.jsx(c,{children:t.size})]}),e.jsx("div",{style:{marginTop:12,marginBottom:12},children:(u=t.tags)==null?void 0:u.map((l,y)=>e.jsx(Q,{size:"small",style:{marginBottom:4},children:l},y))}),e.jsxs("div",{className:"entity-activation-control",children:[e.jsxs(g,{children:[e.jsxs(c,{type:"secondary",style:{fontSize:"12px"},children:[s("entityScan:scanDetail.entityCard.activationStatus"),":"]}),e.jsx(Te,{size:"small",checked:t.status==="active",onChange:l=>{le(t.id,l)},onClick:(l,y)=>{y.stopPropagation()}})]}),e.jsx(c,{className:t.status==="active"?"entity-status-active":"entity-status-inactive",style:{fontSize:"12px"},children:t.status==="active"?s("entityScan:scanDetail.entityCard.activated"):s("entityScan:scanDetail.entityCard.deactivated")})]})]},t.id)};if(!x)return e.jsx("div",{children:s("entityScan:scanDetail.messages.loading")});const $=de(),T=oe();return e.jsxs(Le,{className:"entity-scan-detail-page",children:[e.jsx("div",{className:"breadcrumb-container",children:e.jsxs(L,{children:[e.jsx(L.Item,{children:e.jsx(h,{type:"text",icon:e.jsx(ye,{}),onClick:()=>G("/system-settings/entity-scan"),className:"breadcrumb-back-button",children:s("menu:entityScan")})}),e.jsx(L.Item,{children:e.jsx("span",{className:"breadcrumb-item-span",children:x.name})})]})}),e.jsxs(ke,{children:[e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:8},children:[e.jsx(Re,{level:2,style:{margin:0},children:e.jsxs(g,{children:[te(x.type,x.subType),x.name]})}),e.jsxs(g,{children:[e.jsx(h,{icon:e.jsx(ge,{}),onClick:K,children:s("entityScan:scanDetail.actions.refresh")}),(i==null?void 0:i.status)==="running"?e.jsxs(g,{children:[e.jsx(h,{icon:e.jsx(P,{}),onClick:ne,children:s("entityScan:scanDetail.actions.pauseScan")}),e.jsx(h,{danger:!0,icon:e.jsx(je,{}),onClick:ie,children:s("entityScan:scanDetail.actions.stopScan")})]}):e.jsx(h,{type:"primary",icon:e.jsx(F,{}),onClick:ae,loading:J,children:s("entityScan:scanDetail.actions.startScan")}),e.jsx(h,{icon:e.jsx(Se,{}),onClick:ce,disabled:v.length===0,children:s("entityScan:scanDetail.actions.exportEntities")})]})]}),e.jsx(Y,{style:{marginTop:0,marginBottom:0},children:x.description})]}),i&&e.jsx(fe,{message:e.jsxs(g,{children:[e.jsx(De,{status:M(i.status).color}),M(i.status).text,i.status==="running"&&e.jsx(ve,{percent:Math.round(i.progress),size:"small",className:"scan-progress"})]}),description:e.jsxs("div",{children:[e.jsxs(c,{children:[s("entityScan:scanDetail.scanStatus.startTime"),": ",i.startTime]}),i.endTime&&e.jsxs(e.Fragment,{children:[e.jsx(k,{type:"vertical"}),e.jsxs(c,{children:[s("entityScan:scanDetail.scanStatus.endTime"),": ",i.endTime]})]}),e.jsx(k,{type:"vertical"}),e.jsxs(c,{children:[s("entityScan:scanDetail.scanStatus.foundEntities"),": ",i.entityCount," 个"]}),i.errorCount>0&&e.jsxs(e.Fragment,{children:[e.jsx(k,{type:"vertical"}),e.jsxs(c,{type:"danger",children:[s("entityScan:scanDetail.scanStatus.errors"),": ",i.errorCount," 个"]})]})]}),type:i.status==="failed"?"error":i.status==="running"?"info":"success",className:"scan-alert"}),e.jsxs(m,{gutter:16,style:{marginBottom:24},children:[e.jsx(n,{xs:24,sm:12,md:6,children:e.jsx(j,{className:"stats-card-primary",children:e.jsx(I,{title:s("entityScan:scanDetail.statistics.foundEntities"),value:T.totalEntities,suffix:"个",prefix:e.jsx(we,{})})})}),e.jsx(n,{xs:24,sm:12,md:6,children:e.jsx(j,{className:"stats-card-success",children:e.jsx(I,{title:s("entityScan:scanDetail.statistics.selected"),value:T.selectedEntities,suffix:"个",prefix:e.jsx(A,{})})})}),e.jsx(n,{xs:24,sm:12,md:6,children:e.jsx(j,{className:"stats-card-warning",children:e.jsx(I,{title:s("entityScan:scanDetail.statistics.dataTables"),value:T.tableCount,suffix:"个",prefix:e.jsx(z,{})})})}),e.jsx(n,{xs:24,sm:12,md:6,children:e.jsx(j,{className:"stats-card-purple",children:e.jsx(I,{title:s("entityScan:scanDetail.statistics.views"),value:T.viewCount,suffix:"个",prefix:e.jsx(q,{})})})})]}),e.jsx(ze,{children:e.jsxs(m,{gutter:16,align:"middle",children:[e.jsx(n,{flex:"auto",children:e.jsx($e,{placeholder:s("entityScan:scanDetail.filters.searchPlaceholder"),value:C,onChange:t=>X(t.target.value),style:{width:"100%"},allowClear:!0})}),e.jsx(n,{children:e.jsxs(B,{value:E,onChange:Z,style:{width:120},placeholder:s("entityScan:scanDetail.filters.allTypes"),children:[e.jsx(r,{value:"all",children:s("entityScan:scanDetail.filters.allTypes")}),e.jsx(r,{value:"table",children:s("entityScan:scanDetail.filters.table")}),e.jsx(r,{value:"view",children:s("entityScan:scanDetail.filters.view")}),e.jsx(r,{value:"procedure",children:s("entityScan:scanDetail.filters.procedure")}),e.jsx(r,{value:"function",children:s("entityScan:scanDetail.filters.function")}),e.jsx(r,{value:"api",children:s("entityScan:scanDetail.filters.api")}),e.jsx(r,{value:"file",children:s("entityScan:scanDetail.filters.file")})]})}),e.jsx(n,{children:e.jsxs(B,{value:N,onChange:ee,style:{width:100},placeholder:s("entityScan:scanDetail.filters.allStatuses"),children:[e.jsx(r,{value:"all",children:s("entityScan:scanDetail.filters.allStatuses")}),e.jsx(r,{value:"active",children:s("entityScan:scanDetail.filters.active")}),e.jsx(r,{value:"inactive",children:s("entityScan:scanDetail.filters.inactive")}),e.jsx(r,{value:"warning",children:s("entityScan:scanDetail.filters.warning")})]})})]})}),e.jsx(j,{title:`${s("entityScan:scanDetail.scanResults.title")} (${$.length})`,className:"scan-card",children:$.length>0?e.jsx(Be,{children:$.map(ue)}):e.jsx("div",{style:{textAlign:"center",padding:"40px 0"},children:e.jsx(c,{type:"secondary",children:s("entityScan:scanDetail.messages.noMatchingEntities")})})})]})};export{qe as default};
