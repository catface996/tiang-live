import{j as e,u as Qe,d as O,a as He}from"./index-DWPu_TRF.js";import{T as _e,j as M,ae as ge,t as q,d as Xe,C as we,S as Se,ax as Pe,at as Ye,B as R,n as Me,$ as Je,y as Ue,o as $e,a8 as ke,f as ze,ab as Re,r as x,i as Ae,X as We,a7 as et,ba as tt,bb as nt,bc as st,bd as it,be as rt,bf as ot,aA as at,ai as H,ao as xe,J as lt,K as ct,az as dt,M as ye,l as Ne,bg as pt,b1 as U,ap as gt}from"./antd-DnS9M1TX.js";import{s as De,i as ht}from"./transform-CtUPqxAi.js";import{z as ut,d as mt}from"./zoom-DKpi6doi.js";import{s as xt,l as yt,m as ft,c as vt,a as jt}from"./manyBody-_p2vrwJ2.js";import"./vendor-DJG_os-6.js";const{Title:bt,Text:wt}=_e,At=({topologyData:C,onRefresh:F})=>{const V=()=>{};return e.jsx("div",{className:"topology-header",children:e.jsxs("div",{className:"header-content",children:[e.jsxs("div",{className:"header-left",children:[e.jsx(bt,{level:3,style:{margin:0},children:e.jsxs(M,{children:[e.jsx(ge,{}),C.name]})}),e.jsx("div",{className:"header-description",children:e.jsx(wt,{type:"secondary",children:C.description})}),e.jsx("div",{className:"header-tags",children:e.jsxs(M,{wrap:!0,children:[e.jsx(q,{color:"blue",children:C.type}),e.jsx(q,{color:"green",children:C.plane}),C.tags.map(s=>e.jsx(q,{children:s},s))]})})]}),e.jsx("div",{className:"header-right",children:e.jsxs(Xe,{gutter:16,children:[e.jsx(we,{span:6,children:e.jsx(Se,{title:"节点数",value:C.stats.nodeCount,prefix:e.jsx(ge,{})})}),e.jsx(we,{span:6,children:e.jsx(Se,{title:"连接数",value:C.stats.linkCount,prefix:e.jsx(Pe,{})})}),e.jsx(we,{span:6,children:e.jsx(Se,{title:"健康度",value:C.stats.healthScore,suffix:"%",prefix:e.jsx(Ye,{})})}),e.jsx(we,{span:6,children:e.jsxs(M,{direction:"vertical",children:[e.jsx(R,{icon:e.jsx(Me,{}),onClick:F,children:"刷新"}),e.jsx(R,{icon:e.jsx(Je,{}),onClick:V,children:"导出"})]})})]})})]})})},{Text:fe}=_e,kt=({entities:C,dependencies:F,onDeleteEntity:V,onDeleteDependency:s,onAddEntity:T,onAddDependency:te,onAgentsClick:G})=>{const de=[{title:"名称",dataIndex:"name",key:"name",width:"50%",render:(A,c)=>e.jsxs(M,{children:[e.jsx(ge,{}),e.jsx(fe,{strong:!0,children:A})]})},{title:"类型",dataIndex:"type",key:"type",width:"30%",render:A=>e.jsx("span",{children:A})},{title:"操作",key:"actions",width:"20%",render:(A,c)=>e.jsxs(M,{size:2,children:[e.jsx(R,{type:"text",size:"small",icon:e.jsx(ze,{}),onClick:()=>G(c),title:"查看Agents"}),e.jsx(R,{type:"text",size:"small",danger:!0,icon:e.jsx(Re,{}),onClick:()=>V(c),title:"删除实体"})]})}],ne=[{title:"源实体",dataIndex:"source",key:"source",width:"40%",render:A=>{const c=C.find(se=>se.id===A);return c?e.jsxs(M,{children:[e.jsx(ge,{}),e.jsx(fe,{strong:!0,children:c.name})]}):e.jsx(fe,{type:"secondary",children:A})}},{title:"目标实体",dataIndex:"target",key:"target",width:"40%",render:A=>{const c=C.find(se=>se.id===A);return c?e.jsxs(M,{children:[e.jsx(ge,{}),e.jsx(fe,{strong:!0,children:c.name})]}):e.jsx(fe,{type:"secondary",children:A})}},{title:"操作",key:"actions",width:"20%",render:(A,c)=>e.jsx(R,{type:"text",size:"small",danger:!0,icon:e.jsx(Re,{}),onClick:()=>s(c),title:"删除依赖关系"})}];return e.jsx("div",{className:"content-left",children:e.jsx(Ue,{defaultActiveKey:"entities",className:"data-tabs",items:[{key:"entities",label:e.jsxs(M,{children:[e.jsx(ze,{}),"实体清单 (",C.length,")"]}),children:e.jsxs("div",{children:[e.jsx("div",{style:{marginBottom:16,textAlign:"right"},children:e.jsx(R,{type:"primary",size:"small",icon:e.jsx($e,{}),onClick:T,children:"选择实体"})}),e.jsx(ke,{columns:de,dataSource:C,rowKey:"id",size:"small",pagination:!1,scroll:{y:"calc(100vh - 420px)"}})]})},{key:"dependencies",label:e.jsxs(M,{children:[e.jsx(Pe,{}),"依赖关系 (",F.length,")"]}),children:e.jsxs("div",{children:[e.jsx("div",{style:{marginBottom:16,textAlign:"right"},children:e.jsx(R,{type:"primary",size:"small",icon:e.jsx($e,{}),onClick:te,children:"添加关系"})}),e.jsx(ke,{columns:ne,dataSource:F,rowKey:"id",size:"small",pagination:!1,scroll:{y:"calc(100vh - 420px)"}})]})}]})})},It=[{id:"business_plane",name:"业务应用平面",level:1,color:"#e6f7ff",borderColor:"#1890ff",description:"业务系统和应用服务层",bounds:{minLevel:1,maxLevel:2}},{id:"middleware_plane",name:"中间件平面",level:2,color:"#f9f0ff",borderColor:"#722ed1",description:"中间件和基础服务层",bounds:{minLevel:3,maxLevel:3}},{id:"infrastructure_plane",name:"基础设施平面",level:3,color:"#f0f8f8",borderColor:"#5F9EA0",description:"基础设施和资源层",bounds:{minLevel:4,maxLevel:5}}],Ct=[{id:"web-app-1",name:"Web应用服务",type:"web_application",level:1,plane:"business_plane",description:"前端Web应用服务，处理用户界面交互",status:"active",version:"v2.1.0",instances:3,port:8080,technology:"React + Node.js"},{id:"api-gateway-1",name:"API网关",type:"api_gateway",level:2,plane:"business_plane",description:"统一API入口，处理路由和认证",status:"active",version:"v1.8.2",instances:2,port:8e3,technology:"Kong Gateway"},{id:"user-service-1",name:"用户服务",type:"microservice",level:2,plane:"business_plane",description:"用户管理和认证服务",status:"active",version:"v3.0.1",instances:4,port:8001,technology:"Spring Boot"},{id:"order-service-1",name:"订单服务",type:"microservice",level:2,plane:"business_plane",description:"订单处理和管理服务",status:"active",version:"v2.5.3",instances:6,port:8002,technology:"Spring Boot"},{id:"redis-cluster-1",name:"Redis缓存集群",type:"cache_cluster",level:3,plane:"middleware_plane",description:"分布式缓存集群，提供高速数据访问",status:"active",nodes:6,config:"3主3从",technology:"Redis Cluster",region:"华东-1"},{id:"mq-cluster-1",name:"消息队列集群",type:"message_queue",level:3,plane:"middleware_plane",description:"异步消息处理和服务解耦",status:"active",nodes:3,config:"3节点集群",technology:"RabbitMQ",region:"华东-1"},{id:"mysql-cluster-1",name:"MySQL数据库集群",type:"database_cluster",level:4,plane:"infrastructure_plane",description:"主从数据库集群，存储核心业务数据",status:"active",nodes:3,config:"1主2从",technology:"MySQL 8.0",databases:["user_db","order_db","product_db"],region:"华东-1"},{id:"k8s-cluster-1",name:"Kubernetes集群",type:"container_platform",level:5,plane:"infrastructure_plane",description:"容器编排平台，管理应用部署和扩缩容",status:"active",nodes:12,config:"3主9工作节点",technology:"Kubernetes 1.28",region:"华东-1"},{id:"monitoring-1",name:"监控告警系统",type:"monitoring_system",level:3,plane:"middleware_plane",description:"系统监控、日志收集和告警通知",status:"active",instances:2,technology:"Prometheus + Grafana",metrics:{dailyVolume:1e6,successRate:99.9}}],St=[{source:"web-app-1",target:"api-gateway-1",type:"depends_on",strength:.9},{source:"api-gateway-1",target:"user-service-1",type:"routes_to",strength:.8},{source:"api-gateway-1",target:"order-service-1",type:"routes_to",strength:.8},{source:"user-service-1",target:"redis-cluster-1",type:"uses",strength:.7},{source:"order-service-1",target:"redis-cluster-1",type:"uses",strength:.7},{source:"user-service-1",target:"mysql-cluster-1",type:"stores_in",strength:.9},{source:"order-service-1",target:"mysql-cluster-1",type:"stores_in",strength:.9},{source:"order-service-1",target:"mq-cluster-1",type:"publishes_to",strength:.6},{source:"user-service-1",target:"mq-cluster-1",type:"subscribes_to",strength:.6},{source:"web-app-1",target:"k8s-cluster-1",type:"runs_on",strength:.8},{source:"api-gateway-1",target:"k8s-cluster-1",type:"runs_on",strength:.8},{source:"user-service-1",target:"k8s-cluster-1",type:"runs_on",strength:.8},{source:"order-service-1",target:"k8s-cluster-1",type:"runs_on",strength:.8},{source:"monitoring-1",target:"k8s-cluster-1",type:"monitors",strength:.5},{source:"monitoring-1",target:"mysql-cluster-1",type:"monitors",strength:.5},{source:"monitoring-1",target:"redis-cluster-1",type:"monitors",strength:.5}],Et={levels:[{level:1,name:"前端应用层",color:"#1890ff"},{level:2,name:"业务服务层",color:"#52c41a"},{level:3,name:"中间件层",color:"#722ed1"},{level:4,name:"数据存储层",color:"#faad14"},{level:5,name:"基础设施层",color:"#5F9EA0"}],relationTypes:[{type:"depends_on",description:"依赖于",color:"#1890ff",strokeWidth:2},{type:"routes_to",description:"路由到",color:"#52c41a",strokeWidth:2},{type:"uses",description:"使用",color:"#722ed1",strokeWidth:2},{type:"stores_in",description:"存储在",color:"#faad14",strokeWidth:2},{type:"runs_on",description:"运行在",color:"#f5222d",strokeWidth:2},{type:"publishes_to",description:"发布到",color:"#13c2c2",strokeWidth:1},{type:"subscribes_to",description:"订阅",color:"#eb2f96",strokeWidth:1},{type:"monitors",description:"监控",color:"#8c8c8c",strokeWidth:1}]},ve={planes:It,nodes:Ct,links:St,metadata:Et},_t=O.div`
  width: 100%;
  height: 800px;
  border: 1px solid var(--border-color);
  border-radius: 8px;
  position: relative;
  background-color: var(--background-color);
  overflow: hidden;
`,Tt=O.div`
  position: absolute;
  top: 16px;
  right: 16px;
  z-index: 10;
  background: var(--card-bg);
  border: 1px solid var(--border-color);
  border-radius: 6px;
  padding: 8px;
  box-shadow: var(--card-shadow);
`,$t=O.div`
  position: absolute;
  top: 16px;
  left: 16px;
  z-index: 10;
  background: var(--card-bg);
  border: 1px solid var(--border-color);
  border-radius: 6px;
  box-shadow: var(--card-shadow);
  max-width: 300px;
  transition: all 0.3s ease;
`,zt=O.div`
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 12px;
  border-bottom: 1px solid var(--border-color);
  cursor: pointer;
  user-select: none;

  &:hover {
    background-color: var(--hover-bg);
  }
`,Rt=O.div`
  padding: ${C=>C.collapsed?"0":"12px"};
  max-height: ${C=>C.collapsed?"0":"400px"};
  overflow: hidden;
  transition: all 0.3s ease;
`,Nt=O.div`
  position: absolute;
  background: var(--card-bg);
  border: 1px solid var(--border-color);
  border-radius: 6px;
  padding: 12px;
  box-shadow: var(--card-shadow);
  pointer-events: none;
  z-index: 20;
  max-width: 250px;
  font-size: 12px;
  line-height: 1.4;
`,Dt=({onNodeSelect:C,entities:F,dependencies:V})=>{var pe;const{t:s}=Qe(["common"]),T=x.useRef(null),te=x.useRef(null),[G,de]=x.useState(!0),[ne,A]=x.useState(null),[c,se]=x.useState(null),[m,L]=x.useState(null),[W,je]=x.useState(null),[ie,X]=x.useState(!0),Ie=(r,g)=>r==="agent"?"#722ed1":{1:"#1890ff",2:"#52c41a",3:"#722ed1",4:"#faad14",5:"#5F9EA0"}[g]||"#8c8c8c",Y=r=>({depends_on:"#1890ff",routes_to:"#52c41a",uses:"#722ed1",stores_in:"#faad14",runs_on:"#f5222d",publishes_to:"#13c2c2",subscribes_to:"#eb2f96",monitors:"#8c8c8c",manages:"#722ed1"})[r]||"#d9d9d9",Q=(r,g)=>g==="agent"?22:{1:20,2:18,3:16,4:14,5:12}[r]||14,he=(r,g,y,S)=>{if(g.filter(k=>k.plane===r.id).length===0)return null;const j=S/3;return{x:50,y:(r.level-1)*j+50,width:y-100,height:j-20,rx:12,ry:12}},re=()=>{if(!T.current||!te.current||!c)return;const r=te.current,g=De(T.current),y=r.clientWidth,S=r.clientHeight;g.selectAll("*").remove(),g.attr("width",y).attr("height",S);const f=ut().scaleExtent([.1,3]).on("zoom",n=>{j.attr("transform",n.transform)});g.call(f);const j=g.append("g");j.append("g").attr("class","planes").selectAll("g").data(c.planes).enter().append("g").attr("class","plane").each(function(n){const l=he(n,c.nodes,y,S);if(!l)return;const I=De(this);I.append("rect").attr("x",l.x).attr("y",l.y).attr("width",l.width).attr("height",l.height).attr("rx",l.rx).attr("ry",l.ry).attr("fill",n.color).attr("stroke",n.borderColor).attr("stroke-width",2).attr("stroke-dasharray","5,5").attr("opacity",.3),I.append("text").attr("x",l.x+20).attr("y",l.y+25).attr("font-size","16px").attr("font-weight","bold").attr("fill",n.borderColor).text(n.name),I.append("text").attr("x",l.x+20).attr("y",l.y+45).attr("font-size","12px").attr("fill","var(--text-secondary)").text(n.description)});const o=xt(c.nodes).force("link",yt(c.links).id(n=>n.id).distance(n=>{const l=n.source.level,I=n.target.level;return Math.abs(l-I)===1?80:120}).strength(n=>n.strength)).force("charge",ft().strength(-200)).force("center",vt(y/2,S/2)).force("collision",jt().radius(n=>Q(n.level,n.type)+8)).force("plane",()=>{c.nodes.forEach(n=>{const l=c.planes.find(ce=>ce.id===n.plane);if(!l)return;const I=he(l,c.nodes,y,S);if(!I)return;const h=30,J=I.x+h,Z=I.x+I.width-h,ae=I.y+h+50,le=I.y+I.height-h;n.x<J&&(n.x=J),n.x>Z&&(n.x=Z),n.y<ae&&(n.y=ae),n.y>le&&(n.y=le)})}),k=j.append("defs");c.metadata.relationTypes.forEach(n=>{k.append("marker").attr("id",`arrow-${n.type}`).attr("viewBox","0 -5 10 10").attr("refX",15).attr("refY",0).attr("markerWidth",6).attr("markerHeight",6).attr("orient","auto").append("path").attr("d","M0,-5L10,0L0,5").attr("fill",n.color)});const z=j.append("g").attr("class","links").selectAll("line").data(c.links).enter().append("line").attr("stroke",n=>Y(n.type)).attr("stroke-width",n=>{const l=c.metadata.relationTypes.find(I=>I.type===n.type);return(l==null?void 0:l.strokeWidth)||1}).attr("stroke-opacity",.8).attr("stroke-dasharray",n=>n.type==="manages"?"5,5":null).attr("marker-end",n=>`url(#arrow-${n.type})`),E=j.append("g").attr("class","nodes").selectAll("g").data(c.nodes).enter().append("g").attr("class","node").call(mt().on("start",(n,l)=>{n.active||o.alphaTarget(.3).restart(),l.fx=l.x,l.fy=l.y}).on("drag",(n,l)=>{l.fx=n.x,l.fy=n.y}).on("end",(n,l)=>{n.active||o.alphaTarget(0);const I=c.planes.find(h=>h.id===l.plane);if(I){const h=he(I,c.nodes,y,S);if(h){const Z=h.x+30,ae=h.x+h.width-30,le=h.y+30+50,ce=h.y+h.height-30;l.fx<Z&&(l.fx=Z),l.fx>ae&&(l.fx=ae),l.fy<le&&(l.fy=le),l.fy>ce&&(l.fy=ce)}}}));E.append("circle").attr("r",n=>Q(n.level,n.type)).attr("fill",n=>Ie(n.type,n.level)).attr("stroke","#fff").attr("stroke-width",2).style("cursor","pointer"),E.filter(n=>n.type==="agent").append("text").text("🤖").attr("x",0).attr("y",5).attr("text-anchor","middle").attr("font-size",n=>Q(n.level,n.type)*.8).style("pointer-events","none"),E.append("text").text(n=>n.name).attr("x",0).attr("y",n=>Q(n.level,n.type)+15).attr("text-anchor","middle").attr("font-size","10px").attr("fill","var(--text-color)").style("pointer-events","none"),E.on("mouseover",(n,l)=>{const I=new Set;I.add(l.id),c.links.forEach(h=>{const J=typeof h.source=="string"?h.source:h.source.id,Z=typeof h.target=="string"?h.target:h.target.id;J===l.id&&I.add(Z),Z===l.id&&I.add(J)}),E.style("opacity",h=>I.has(h.id)?1:.3),z.style("opacity",h=>{const J=typeof h.source=="string"?h.source:h.source.id,Z=typeof h.target=="string"?h.target:h.target.id;return J===l.id||Z===l.id?1:.1}),je({x:n.pageX+10,y:n.pageY-10,content:l})}).on("mouseout",()=>{E.style("opacity",1),z.style("opacity",.8),je(null)}).on("click",(n,l)=>{L(l),C==null||C(l)}),o.on("tick",()=>{z.attr("x1",n=>n.source.x).attr("y1",n=>n.source.y).attr("x2",n=>n.target.x).attr("y2",n=>n.target.y),E.attr("transform",n=>`translate(${n.x},${n.y})`)});const _=()=>{g.transition().call(f.scaleBy,1.5)},i=()=>{g.transition().call(f.scaleBy,1/1.5)},w=()=>{g.transition().call(f.transform,ht)},oe=()=>{c.nodes.forEach(n=>{n.fx=null,n.fy=null}),o.alpha(1).restart()};T.current.zoomIn=_,T.current.zoomOut=i,T.current.resetZoom=w,T.current.resetNodePositions=oe},N=(r,g)=>{const y=[{id:"business_plane",name:"业务应用平面",level:1,color:"#e6f7ff",borderColor:"#1890ff",description:"业务系统和应用服务层",bounds:{minLevel:1,maxLevel:2}},{id:"middleware_plane",name:"中间件平面",level:2,color:"#f9f0ff",borderColor:"#722ed1",description:"中间件和基础服务层",bounds:{minLevel:3,maxLevel:3}},{id:"infrastructure_plane",name:"基础设施平面",level:3,color:"#f0f8f8",borderColor:"#5F9EA0",description:"基础设施和资源层",bounds:{minLevel:4,maxLevel:5}}],S=r.map(b=>{let o=2,k="business_plane";return b.type.includes("cache")||b.type.includes("message")||b.type.includes("monitoring")?(o=3,k="middleware_plane"):(b.type.includes("database")||b.type.includes("container")||b.type.includes("cluster"))&&(o=4,k="infrastructure_plane"),{id:b.id,name:b.name,type:b.type,level:o,plane:k,description:b.properties.description||`${b.name} - ${b.type}`,status:b.status,...b.properties}}),f=g.map(b=>({source:b.source,target:b.target,type:b.type,strength:b.strength}));return{planes:y,nodes:S,links:f,metadata:{levels:[{level:1,name:"前端应用层",color:"#1890ff"},{level:2,name:"业务服务层",color:"#52c41a"},{level:3,name:"中间件层",color:"#722ed1"},{level:4,name:"数据存储层",color:"#faad14"},{level:5,name:"基础设施层",color:"#5F9EA0"}],relationTypes:[{type:"depends_on",description:"依赖于",color:"#1890ff",strokeWidth:2},{type:"provides_to",description:"提供给",color:"#52c41a",strokeWidth:2},{type:"connects_to",description:"连接到",color:"#faad14",strokeWidth:2}]}}};x.useEffect(()=>{try{if(de(!0),F&&V){const r=N(F,V);se(r)}else se(ve);A(null)}catch{A("Failed to load entity topology data")}finally{de(!1)}},[F,V]),x.useEffect(()=>{if(c&&!G){const r=setTimeout(()=>{re()},100);return()=>clearTimeout(r)}},[c,G]),x.useEffect(()=>{const r=()=>{c&&!G&&re()};return window.addEventListener("resize",r),()=>window.removeEventListener("resize",r)},[c,G]);const ue=()=>{var r,g;(g=(r=T.current)==null?void 0:r.zoomIn)==null||g.call(r)},D=()=>{var r,g;(g=(r=T.current)==null?void 0:r.zoomOut)==null||g.call(r)},me=()=>{var r,g;(g=(r=T.current)==null?void 0:r.resetZoom)==null||g.call(r)},ee=()=>{var r,g;(g=(r=T.current)==null?void 0:r.resetNodePositions)==null||g.call(r)},be=()=>{re()},Ce=async()=>{console.log("🔍 开始分析诊断...");const r=F||[],g=V||[],y=r.filter(o=>o.type!=="agent"),S=r.filter(o=>o.type==="agent"),f=g.filter(o=>{const k=S.some(E=>E.id===o.source),z=S.some(E=>E.id===o.target);return!k&&!z}),j=g.filter(o=>{const k=S.some(E=>E.id===o.source),z=S.some(E=>E.id===o.target);return k||z}),b={timestamp:new Date().toISOString(),topologyId:"topology-"+Date.now(),entities:y.map(o=>({id:o.id,name:o.name,type:o.type,status:o.status,connections:o.connections,properties:o.properties})),agents:S.map(o=>{var k,z,E,_,i;return{id:o.id,name:o.name,type:o.type,status:o.status,agentType:((k=o.properties)==null?void 0:k.agentType)||"unknown",capabilities:((z=o.properties)==null?void 0:z.capabilities)||[],version:((E=o.properties)==null?void 0:E.version)||"unknown",lastActive:((_=o.properties)==null?void 0:_.lastActive)||new Date().toISOString(),description:((i=o.properties)==null?void 0:i.description)||""}}),entityDependencies:f.map(o=>({id:o.id,source:o.source,target:o.target,type:o.type,strength:o.strength,description:o.description})),entityAgentRelations:j.map(o=>({id:o.id,entityId:o.type==="manages"?o.target:o.source,agentId:o.type==="manages"?o.source:o.target,relationType:o.type,strength:o.strength,description:o.description,createdAt:new Date().toISOString()})),analysisRequest:{checkHealthStatus:!0,detectAnomalies:!0,performanceAnalysis:!0,securityCheck:!0,dependencyAnalysis:!0,agentEfficiencyAnalysis:!0}};console.log("📊 准备发送的分析数据:",b);try{console.log("🚀 模拟发送POST请求到: /api/v1/topology/analysis"),console.log("📤 请求头:",{"Content-Type":"application/json",Authorization:"Bearer <token>","X-Request-ID":"req-"+Date.now()}),console.log("📦 请求体:",JSON.stringify(b,null,2)),await new Promise(i=>setTimeout(i,1500));const o=y.filter(i=>i.status==="active"),k=y.filter(i=>i.status==="warning"),z=y.filter(i=>i.status==="error"),E=S.filter(i=>i.status==="active"),_={success:!0,requestId:"req-"+Date.now(),analysisId:"analysis-"+Date.now(),timestamp:new Date().toISOString(),results:{summary:{totalEntities:y.length,totalAgents:S.length,totalEntityDependencies:f.length,totalEntityAgentRelations:j.length,overallHealth:z.length>0?"critical":k.length>0?"warning":"good",healthScore:Math.max(60,100-z.length*20-k.length*10)},entityAnalysis:{activeEntities:o.length,warningEntities:k.length,errorEntities:z.length,orphanedEntities:y.filter(i=>!f.some(w=>w.source===i.id||w.target===i.id)&&!j.some(w=>w.entityId===i.id)).length,criticalEntities:y.filter(i=>{const w=f.filter(n=>n.target===i.id).length,oe=f.filter(n=>n.source===i.id).length;return w+oe>3}).map(i=>({id:i.id,name:i.name,connectionCount:f.filter(w=>w.source===i.id||w.target===i.id).length}))},agentAnalysis:{activeAgents:E.length,agentCoverage:j.length>0?(j.length/Math.max(y.length,1)*100).toFixed(1)+"%":"0%",agentEfficiency:S.map(i=>{var w;return{id:i.id,name:i.name,managedEntities:j.filter(oe=>oe.agentId===i.id).length,status:i.status,capabilities:((w=i.properties)==null?void 0:w.capabilities)||[]}}),unmanagedEntities:y.filter(i=>!j.some(w=>w.entityId===i.id)).map(i=>({id:i.id,name:i.name,type:i.type}))},dependencyAnalysis:{totalDependencies:f.length,dependencyTypes:[...new Set(f.map(i=>i.type))],circularDependencies:[],strongDependencies:f.filter(i=>i.strength>.8).length,weakDependencies:f.filter(i=>i.strength<=.5).length},relationAnalysis:{totalRelations:j.length,relationTypes:[...new Set(j.map(i=>i.relationType))],agentUtilization:S.map(i=>({agentId:i.id,agentName:i.name,relationCount:j.filter(w=>w.agentId===i.id).length,utilizationRate:j.filter(w=>w.agentId===i.id).length>0?"active":"idle"}))},issues:[...z.length>0?[{type:"error",severity:"high",category:"entity_health",message:`发现 ${z.length} 个实体状态异常`,affectedItems:z.map(i=>i.id),recommendation:"立即检查异常实体的日志和配置"}]:[],...k.length>0?[{type:"warning",severity:"medium",category:"entity_health",message:`发现 ${k.length} 个实体状态警告`,affectedItems:k.map(i=>i.id),recommendation:"检查警告实体的性能指标"}]:[],...S.length===0?[{type:"warning",severity:"medium",category:"agent_coverage",message:"未部署任何Agent，缺乏智能监控能力",affectedItems:["topology"],recommendation:"建议部署监控和管理Agent"}]:[],...j.length<y.length*.5?[{type:"info",severity:"low",category:"agent_coverage",message:"Agent覆盖率较低，部分实体缺乏智能管理",affectedItems:["agent_coverage"],recommendation:"考虑为更多实体配置Agent管理"}]:[]],recommendations:[...E.length>0?["Agent监控系统运行正常"]:["建议部署Agent监控系统"],...f.length>y.length*2?["拓扑复杂度较高，建议优化依赖关系"]:[],"定期检查实体健康状态","优化Agent资源分配","建立完善的监控告警机制"]}};console.log("✅ 模拟后端响应:",_),console.log("📈 分析结果摘要:"),console.log(`   - 实体数量: ${_.results.summary.totalEntities}`),console.log(`   - Agent数量: ${_.results.summary.totalAgents}`),console.log(`   - 实体依赖关系: ${_.results.summary.totalEntityDependencies} 个`),console.log(`   - 实体-Agent关系: ${_.results.summary.totalEntityAgentRelations} 个`),console.log(`   - 整体健康度: ${_.results.summary.overallHealth} (${_.results.summary.healthScore}/100)`),console.log(`   - Agent覆盖率: ${_.results.agentAnalysis.agentCoverage}`),_.results.agentAnalysis.agentEfficiency.length>0&&(console.log("🤖 Agent效率分析:"),_.results.agentAnalysis.agentEfficiency.forEach((i,w)=>{console.log(`   ${w+1}. ${i.name}`),console.log(`      状态: ${i.status}`),console.log(`      管理实体: ${i.managedEntities} 个`),console.log(`      能力: ${Array.isArray(i.capabilities)?i.capabilities.join(", "):i.capabilities}`)})),_.results.agentAnalysis.unmanagedEntities.length>0&&(console.log("⚠️  未被Agent管理的实体:"),_.results.agentAnalysis.unmanagedEntities.forEach((i,w)=>{console.log(`   ${w+1}. ${i.name} (${i.type})`)})),_.results.issues.length>0&&(console.log("🚨 发现的问题:"),_.results.issues.forEach((i,w)=>{console.log(`   ${w+1}. [${i.severity.toUpperCase()}] ${i.message}`),console.log(`      类别: ${i.category}`),console.log(`      建议: ${i.recommendation}`)})),console.log("🎯 分析诊断完成!")}catch(o){console.error("❌ 分析诊断失败:",o),console.log("🔄 建议重试或联系系统管理员")}};return G?e.jsx(Ae,{children:e.jsxs("div",{style:{textAlign:"center",padding:"100px 0"},children:[e.jsx(We,{size:"large"}),e.jsx("div",{style:{marginTop:16},children:"加载实体拓扑图..."})]})}):ne?e.jsx(Ae,{children:e.jsx(et,{message:"错误",description:ne,type:"error",showIcon:!0})}):e.jsxs(Ae,{title:e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[e.jsx("span",{children:"实体拓扑关系图"}),e.jsx(R,{type:"primary",size:"small",icon:e.jsx(at,{}),onClick:Ce,children:"分析诊断"})]}),style:{marginBottom:24},children:[e.jsxs(_t,{ref:te,children:[e.jsx("svg",{ref:T}),e.jsx(Tt,{children:e.jsxs(M,{direction:"vertical",size:"small",children:[e.jsx(R,{size:"small",icon:e.jsx(tt,{}),onClick:ue,title:"放大"}),e.jsx(R,{size:"small",icon:e.jsx(nt,{}),onClick:D,title:"缩小"}),e.jsx(R,{size:"small",icon:e.jsx(st,{}),onClick:me,title:"重置视图"}),e.jsx(R,{size:"small",icon:e.jsx(it,{}),onClick:ee,title:"重置节点位置"}),e.jsx(R,{size:"small",icon:e.jsx(Me,{}),onClick:be,title:"刷新图表"})]})}),e.jsxs($t,{children:[e.jsxs(zt,{onClick:()=>X(!ie),children:[e.jsx("div",{style:{fontWeight:"bold",fontSize:"14px"},children:"图例"}),ie?e.jsx(rt,{}):e.jsx(ot,{})]}),e.jsxs(Rt,{collapsed:ie,children:[e.jsxs("div",{style:{marginBottom:12},children:[e.jsx("div",{style:{marginBottom:4,fontSize:"12px",fontWeight:"bold"},children:"平面:"}),c==null?void 0:c.planes.map(r=>e.jsxs("div",{style:{display:"flex",alignItems:"center",marginBottom:2},children:[e.jsx("div",{style:{width:16,height:12,backgroundColor:r.color,border:`1px solid ${r.borderColor}`,borderRadius:2,marginRight:6}}),e.jsx("span",{style:{fontSize:"11px"},children:r.name})]},r.id))]}),e.jsxs("div",{style:{marginBottom:8},children:[e.jsx("div",{style:{marginBottom:4,fontSize:"12px",fontWeight:"bold"},children:"节点类型:"}),e.jsxs("div",{style:{display:"flex",alignItems:"center",marginBottom:2},children:[e.jsx("div",{style:{width:12,height:12,borderRadius:"50%",backgroundColor:"#722ed1",marginRight:6,display:"flex",alignItems:"center",justifyContent:"center",fontSize:"8px"},children:"🤖"}),e.jsx("span",{style:{fontSize:"11px"},children:"AI Agent"})]}),c==null?void 0:c.metadata.levels.map(r=>e.jsxs("div",{style:{display:"flex",alignItems:"center",marginBottom:2},children:[e.jsx("div",{style:{width:12,height:12,borderRadius:"50%",backgroundColor:r.color,marginRight:6}}),e.jsx("span",{style:{fontSize:"11px"},children:r.name})]},r.level))]}),e.jsxs("div",{children:[e.jsx("div",{style:{marginBottom:4,fontSize:"12px",fontWeight:"bold"},children:"关系类型:"}),e.jsxs("div",{style:{display:"flex",alignItems:"center",marginBottom:2},children:[e.jsx("div",{style:{width:16,height:2,backgroundColor:"#722ed1",marginRight:6,borderTop:"2px dashed #722ed1",backgroundColor:"transparent"}}),e.jsx("span",{style:{fontSize:"11px"},children:"Agent管理"})]}),c==null?void 0:c.metadata.relationTypes.map(r=>e.jsxs("div",{style:{display:"flex",alignItems:"center",marginBottom:2},children:[e.jsx("div",{style:{width:16,height:2,backgroundColor:r.color,marginRight:6}}),e.jsx("span",{style:{fontSize:"11px"},children:r.description})]},r.type))]})]})]}),W&&e.jsxs(Nt,{style:{left:W.x,top:W.y},children:[e.jsx("div",{style:{fontWeight:"bold",marginBottom:4},children:W.content.name}),e.jsxs("div",{style:{marginBottom:2},children:["类型: ",W.content.type]}),e.jsxs("div",{style:{marginBottom:2},children:["层级: ",W.content.level]}),e.jsxs("div",{style:{marginBottom:2},children:["平面: ",W.content.plane]}),e.jsxs("div",{style:{marginBottom:2},children:["状态:",e.jsx(q,{color:W.content.status==="active"?"green":"red",size:"small",style:{marginLeft:4},children:W.content.status})]}),e.jsx("div",{style:{fontSize:"11px",color:"var(--text-secondary)"},children:W.content.description})]})]}),m&&e.jsx(Ae,{title:`节点详情: ${m.name}`,size:"small",style:{marginTop:16},extra:e.jsx(R,{size:"small",onClick:()=>L(null),children:"关闭"}),children:e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"repeat(auto-fit, minmax(200px, 1fr))",gap:16},children:[e.jsxs("div",{children:[e.jsx("strong",{children:"基本信息:"}),e.jsxs("div",{children:["ID: ",m.id]}),e.jsxs("div",{children:["类型: ",m.type]}),e.jsxs("div",{children:["层级: ",m.level]}),e.jsxs("div",{children:["平面: ",m.plane]}),e.jsxs("div",{children:["状态: ",e.jsx(q,{color:m.status==="active"?"green":"red",children:m.status})]})]}),e.jsxs("div",{children:[e.jsx("strong",{children:"描述:"}),e.jsx("div",{children:m.description})]}),m.instances&&e.jsxs("div",{children:[e.jsx("strong",{children:"实例信息:"}),e.jsxs("div",{children:["实例数: ",m.instances]}),m.version&&e.jsxs("div",{children:["版本: ",m.version]}),m.technology&&e.jsxs("div",{children:["技术栈: ",m.technology]})]}),m.nodes&&e.jsxs("div",{children:[e.jsx("strong",{children:"集群信息:"}),e.jsxs("div",{children:["节点数: ",m.nodes]}),m.config&&e.jsxs("div",{children:["配置: ",m.config]}),m.technology&&e.jsxs("div",{children:["技术: ",m.technology]}),m.region&&e.jsxs("div",{children:["区域: ",m.region]})]}),m.databases&&e.jsxs("div",{children:[e.jsx("strong",{children:"数据库:"}),e.jsx("div",{style:{marginTop:4},children:m.databases.map((r,g)=>e.jsx(q,{color:"blue",style:{marginBottom:4},children:r},g))})]}),m.metrics&&e.jsxs("div",{children:[e.jsx("strong",{children:"业务指标:"}),e.jsxs("div",{children:["日均量: ",(pe=m.metrics.dailyVolume)==null?void 0:pe.toLocaleString()]}),e.jsxs("div",{children:["成功率: ",m.metrics.successRate,"%"]})]})]})})]})},Bt=[{id:"web-portal-1",name:"企业门户网站",type:"web_application",status:"active",properties:{description:"企业官方门户网站，提供产品展示和用户服务",technology:"React + Node.js",environment:"production",version:"2.1.0"},connections:0},{id:"mobile-app-1",name:"移动应用客户端",type:"mobile_application",status:"active",properties:{description:"iOS和Android移动应用",technology:"React Native",environment:"production",version:"1.8.2"},connections:0},{id:"payment-service-1",name:"支付服务",type:"microservice",status:"active",properties:{description:"处理支付相关业务逻辑",technology:"Spring Boot",environment:"production",version:"3.2.1"},connections:0},{id:"notification-service-1",name:"通知服务",type:"microservice",status:"active",properties:{description:"统一消息通知服务",technology:"Spring Boot",environment:"production",version:"2.5.0"},connections:0},{id:"elasticsearch-cluster-1",name:"搜索引擎集群",type:"search_engine",status:"active",properties:{description:"Elasticsearch搜索引擎集群",technology:"Elasticsearch",environment:"production",version:"8.5.0"},connections:0},{id:"kafka-cluster-1",name:"消息队列集群",type:"message_queue",status:"active",properties:{description:"Apache Kafka消息队列集群",technology:"Apache Kafka",environment:"production",version:"3.3.0"},connections:0},{id:"postgres-primary-1",name:"PostgreSQL主库",type:"database",status:"active",properties:{description:"PostgreSQL主数据库",technology:"PostgreSQL",environment:"production",version:"14.6"},connections:0},{id:"postgres-replica-1",name:"PostgreSQL从库",type:"database",status:"active",properties:{description:"PostgreSQL只读从库",technology:"PostgreSQL",environment:"production",version:"14.6"},connections:0},{id:"cdn-service-1",name:"CDN加速服务",type:"cdn",status:"active",properties:{description:"内容分发网络服务",technology:"CloudFlare",environment:"production",version:"latest"},connections:0},{id:"backup-service-1",name:"备份服务",type:"backup_system",status:"active",properties:{description:"数据备份和恢复服务",technology:"Custom Script",environment:"production",version:"1.0.0"},connections:0},{id:"log-aggregator-1",name:"日志聚合服务",type:"logging_system",status:"active",properties:{description:"ELK日志聚合和分析系统",technology:"ELK Stack",environment:"production",version:"8.5.0"},connections:0},{id:"security-scanner-1",name:"安全扫描服务",type:"security_system",status:"warning",properties:{description:"安全漏洞扫描和监控",technology:"OWASP ZAP",environment:"production",version:"2.12.0"},connections:0}],Lt={entities:Bt},Pt=[{id:"monitoring-agent-1",name:"系统监控Agent",type:"monitoring",status:"active",description:"负责系统性能监控和告警",capabilities:["性能监控","日志分析","告警通知"],version:"2.1.0",lastActive:"2024-12-20T10:30:00Z"},{id:"security-agent-1",name:"安全扫描Agent",type:"security",status:"active",description:"执行安全漏洞扫描和威胁检测",capabilities:["漏洞扫描","威胁检测","安全评估"],version:"1.5.2",lastActive:"2024-12-20T09:45:00Z"},{id:"backup-agent-1",name:"数据备份Agent",type:"backup",status:"active",description:"自动化数据备份和恢复管理",capabilities:["数据备份","增量备份","恢复管理"],version:"3.0.1",lastActive:"2024-12-20T08:15:00Z"},{id:"deployment-agent-1",name:"部署管理Agent",type:"deployment",status:"active",description:"自动化应用部署和版本管理",capabilities:["自动部署","版本管理","回滚操作"],version:"2.3.0",lastActive:"2024-12-20T11:20:00Z"},{id:"log-agent-1",name:"日志收集Agent",type:"logging",status:"active",description:"集中化日志收集和分析处理",capabilities:["日志收集","日志解析","异常检测"],version:"1.8.5",lastActive:"2024-12-20T10:50:00Z"},{id:"performance-agent-1",name:"性能优化Agent",type:"performance",status:"active",description:"应用性能分析和优化建议",capabilities:["性能分析","瓶颈识别","优化建议"],version:"2.0.3",lastActive:"2024-12-20T09:30:00Z"},{id:"config-agent-1",name:"配置管理Agent",type:"configuration",status:"active",description:"配置文件管理和变更追踪",capabilities:["配置管理","变更追踪","配置验证"],version:"1.6.0",lastActive:"2024-12-20T08:45:00Z"},{id:"network-agent-1",name:"网络监控Agent",type:"network",status:"active",description:"网络连接监控和流量分析",capabilities:["网络监控","流量分析","连接诊断"],version:"2.2.1",lastActive:"2024-12-20T10:15:00Z"},{id:"health-agent-1",name:"健康检查Agent",type:"health",status:"active",description:"服务健康状态检查和自愈",capabilities:["健康检查","自动恢复","状态报告"],version:"1.9.0",lastActive:"2024-12-20T11:00:00Z"},{id:"scaling-agent-1",name:"弹性伸缩Agent",type:"scaling",status:"active",description:"根据负载自动调整资源规模",capabilities:["自动伸缩","负载监控","资源调度"],version:"2.4.2",lastActive:"2024-12-20T09:20:00Z"},{id:"ai-analysis-agent-1",name:"AI分析Agent",type:"ai_analysis",status:"active",description:"基于AI的智能分析和预测",capabilities:["智能分析","异常预测","趋势识别"],version:"3.1.0",lastActive:"2024-12-20T10:40:00Z"},{id:"compliance-agent-1",name:"合规检查Agent",type:"compliance",status:"warning",description:"合规性检查和审计报告",capabilities:["合规检查","审计报告","风险评估"],version:"1.7.3",lastActive:"2024-12-20T07:30:00Z"}],Ee={agents:Pt},{Title:Xt,Text:Yt}=_e,Mt=O.div`
  background: var(--bg-tertiary);
  border: 1px solid var(--border-secondary);
  padding: 12px;
  border-radius: 6px;
  margin: 12px 0;
  text-align: center;
  transition: all 0.3s ease;

  .entity-name {
    font-weight: bold;
    color: var(--text-primary);
  }

  .arrow {
    margin: 0 8px;
    color: var(--primary-color);
    font-weight: bold;
    font-size: 16px;
  }

  &:hover {
    background: var(--bg-elevated);
    border-color: var(--border-hover);
  }
`,Wt=O.p`
  font-size: 12px;
  color: var(--text-secondary);
  margin: 8px 0 0 0;
`,Be=O.p`
  color: var(--text-tertiary);
  font-size: 12px;
  margin: 8px 0 0 0;
`,Ot=O.p`
  color: var(--error-color);
  font-weight: 500;
  margin: 8px 0;
`,Le=O.div`
  background: var(--bg-tertiary);
  border: 1px solid var(--border-secondary);
  padding: 12px;
  border-radius: 6px;
  margin-bottom: 16px;

  p {
    color: var(--text-secondary);
    margin: 0;
    font-size: 14px;
  }

  .highlight {
    color: var(--primary-color);
    font-weight: 500;
  }
`,Zt=O.div`
  .form-item {
    margin-bottom: 20px;
  }

  .form-label {
    display: block;
    margin-bottom: 8px;
    font-weight: 500;
    color: var(--text-primary);
  }

  .entity-select {
    width: 100%;
  }

  .relationship-preview {
    background: var(--bg-tertiary);
    border: 1px solid var(--border-secondary);
    padding: 16px;
    border-radius: 6px;
    margin: 16px 0;
    text-align: center;

    .preview-content {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      font-size: 16px;
    }

    .entity-name {
      font-weight: bold;
      color: var(--text-primary);
      padding: 4px 8px;
      background: var(--bg-elevated);
      border-radius: 4px;
    }

    .arrow {
      color: var(--primary-color);
      font-weight: bold;
      font-size: 18px;
    }

    .relationship-type {
      font-size: 12px;
      color: var(--text-secondary);
      margin-top: 8px;
    }
  }
`,Kt=O.div`
  background: var(--bg-tertiary);
  border: 1px solid var(--border-secondary);
  padding: 12px;
  border-radius: 6px;
  margin-bottom: 16px;

  p {
    color: var(--text-secondary);
    margin: 0;
    font-size: 14px;
  }

  .highlight {
    color: var(--primary-color);
    font-weight: 500;
  }

  .entity-info {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-top: 8px;
    padding: 8px;
    background: var(--bg-elevated);
    border-radius: 4px;

    .entity-name {
      font-weight: bold;
      color: var(--text-primary);
    }

    .entity-type {
      font-size: 12px;
      color: var(--text-secondary);
    }
  }
`,Jt=()=>{const{id:C}=He(),[F,V]=x.useState(!0),[s,T]=x.useState(null),[te,G]=x.useState(null),[de,ne]=x.useState(!1),[A,c]=x.useState(null),[se,m]=x.useState(!1),[L,W]=x.useState(null),[je,ie]=x.useState(!1),[X,Ie]=x.useState([]),[Y,Q]=x.useState([]),[he,re]=x.useState(!1),[N,ue]=x.useState(""),[D,me]=x.useState(""),[ee,be]=x.useState("depends_on"),[Ce,pe]=x.useState(!1),[r,g]=x.useState(null),[y,S]=x.useState([]),[f,j]=x.useState([]),[b,o]=x.useState([]),k=x.useCallback(async()=>{V(!0);try{const t=ve.nodes.map(u=>({id:u.id,name:u.name,type:u.type,status:u.status,properties:{level:u.level,plane:u.plane,description:u.description,...Object.fromEntries(Object.entries(u).filter(([B])=>!["id","name","type","level","plane","description","status"].includes(B)))},connections:0}));t.forEach(u=>{u.connections=ve.links.filter(B=>B.source===u.id||B.target===u.id).length});const a=ve.links.map((u,B)=>{var p;return{id:`dep-${B+1}`,source:u.source,target:u.target,type:u.type,strength:u.strength,description:((p=ve.metadata.relationTypes.find(K=>K.type===u.type))==null?void 0:p.description)||u.type.replace("_"," ")}}),d={id:C||"1",name:"企业应用拓扑",description:"企业核心应用系统拓扑图，展示前端应用、业务服务、中间件和基础设施的依赖关系。",type:"application",status:"active",plane:"应用平面",tags:["核心","生产环境","微服务"],stats:{nodeCount:t.length,linkCount:a.length,healthScore:98,lastUpdated:"2024-07-02 09:00:00"},entities:t,dependencies:a};T(d),S(Ee.agents);const v=[{id:"binding-sample-1",entityId:"web-app-1",agentId:"monitoring-agent-1",bindingType:"monitoring",createdAt:new Date().toISOString()}];o(v)}catch(t){console.error("Failed to load topology detail:",t),H.error("加载拓扑数据失败")}finally{V(!1)}},[C]);x.useEffect(()=>{k()},[k]);const z=t=>{g(t);const a=b.filter(d=>d.entityId===t.id).map(d=>d.agentId);S(Ee.agents),j(a),pe(!0)},E=()=>{if(!r||f.length===0){H.warning("请选择要绑定的Agent");return}const a=b.filter(P=>P.entityId===r.id).map(P=>P.agentId),d=f.filter(P=>!a.includes(P)),v=a.filter(P=>!f.includes(P)),u=d.map(P=>({id:`binding-${r.id}-${P}-${Date.now()}`,entityId:r.id,agentId:P,bindingType:"monitoring",createdAt:new Date().toISOString()})),B=[...b.filter(P=>!(P.entityId===r.id&&v.includes(P.agentId))),...u];o(B),s&&w(B);const p=d.length,K=v.length;let $="";p>0&&K>0?$=`成功绑定 ${p} 个Agent，解绑 ${K} 个Agent`:p>0?$=`成功绑定 ${p} 个Agent到 ${r.name}`:K>0?$=`成功解绑 ${K} 个Agent`:$="Agent绑定状态无变化",H.success($),pe(!1)},_=()=>{pe(!1),g(null),j([])},i=t=>{j(t)},w=t=>{if(!s)return;const a=[...new Set(t.map(p=>p.agentId))],d=Ee.agents.filter(p=>a.includes(p.id)).map(p=>({id:p.id,name:p.name,type:"agent",level:0,status:p.status,properties:{description:p.description,agentType:p.type,capabilities:p.capabilities.join(", "),version:p.version,lastActive:p.lastActive},connections:t.filter(K=>K.agentId===p.id).length})),v=t.map(p=>({id:`agent-conn-${p.id}`,source:p.agentId,target:p.entityId,type:"manages",description:"管理",strength:.8})),u=[...s.entities.filter(p=>p.type!=="agent"),...d],B=[...s.dependencies.filter(p=>!p.id.startsWith("agent-conn-")),...v];T({...s,entities:u,dependencies:B,stats:{...s.stats,nodeCount:u.length,linkCount:B.length}})},oe=t=>{c(t),ne(!0)},n=()=>{if(!s||!A)return;const t=s.dependencies.filter(v=>v.source===A.id||v.target===A.id),a=s.entities.filter(v=>v.id!==A.id),d=s.dependencies.filter(v=>v.source!==A.id&&v.target!==A.id);T({...s,entities:a,dependencies:d,stats:{...s.stats,nodeCount:a.length,linkCount:d.length}}),te&&te.id===A.id&&G(null),H.success(`成功删除实体 "${A.name}"${t.length>0?` 及 ${t.length} 个相关依赖关系`:""}`),ne(!1),c(null)},l=()=>{ne(!1),c(null)},I=t=>{W(t),m(!0)},h=()=>{if(!s||!L)return;const t=s.dependencies.filter(p=>p.id!==L.id),a=s.entities.map(p=>{const K=t.filter($=>$.source===p.id||$.target===p.id).length;return{...p,connections:K}});T({...s,entities:a,dependencies:t,stats:{...s.stats,linkCount:t.length}});const d=s.entities.find(p=>p.id===L.source),v=s.entities.find(p=>p.id===L.target),u=d?d.name:L.source,B=v?v.name:L.target;H.success(`成功删除依赖关系 "${u} → ${B}"`),m(!1),W(null)},J=()=>{m(!1),W(null)},Z=()=>{if(!s||s.entities.length<2){H.warning("至少需要2个实体才能建立依赖关系");return}ue(""),me(""),be("depends_on"),re(!0)},ae=()=>{if(!s||!N||!D){H.error("请选择源实体和目标实体");return}if(N===D){H.error("源实体和目标实体不能相同");return}if(s.dependencies.find($=>$.source===N&&$.target===D&&$.type===ee)){H.error("该依赖关系已存在");return}const a={id:`dep-${Date.now()}`,source:N,target:D,type:ee,description:ce(ee),strength:1},d=[...s.dependencies,a],v=s.entities.map($=>{const P=d.filter(Te=>Te.source===$.id||Te.target===$.id).length;return{...$,connections:P}});T({...s,entities:v,dependencies:d,stats:{...s.stats,linkCount:d.length}});const u=s.entities.find($=>$.id===N),B=s.entities.find($=>$.id===D),p=u?u.name:N,K=B?B.name:D;H.success(`成功创建依赖关系：${p} → ${K}`),re(!1)},le=()=>{re(!1)},ce=t=>({depends_on:"依赖于",connects_to:"连接到",uses:"使用",routes_to:"路由到",stores_in:"存储在",reads_from:"读取自",writes_to:"写入到",monitors:"监控",backs_up:"备份"})[t]||t,Oe=()=>{const t=N;ue(D),me(t)},Ze=()=>{const t=(s==null?void 0:s.entities.map(d=>d.id))||[],a=Lt.entities.filter(d=>!t.includes(d.id));Ie(a),Q([]),ie(!0)},Ke=()=>{if(!s||Y.length===0)return;const t=X.filter(d=>Y.includes(d.id)),a=[...s.entities,...t];T({...s,entities:a,stats:{...s.stats,nodeCount:a.length}}),H.success(`成功添加 ${t.length} 个实体到拓扑图`),ie(!1),Q([])},qe=()=>{ie(!1),Q([])},Fe=t=>{Q(t)},Ve=()=>{const t=X.map(a=>a.id);Q(t)},Ge=()=>{Q([])};return F?e.jsx("div",{className:"entity-topology-detail-loading",children:e.jsx(We,{size:"large"})}):s?e.jsxs("div",{className:"entity-topology-detail",children:[e.jsx("div",{className:"breadcrumb-container",children:e.jsx(lt,{items:[{href:"/dashboard",title:e.jsxs(M,{children:[e.jsx(ct,{}),e.jsx("span",{children:"首页"})]})},{href:"/test-tools",title:e.jsxs(M,{children:[e.jsx(dt,{}),e.jsx("span",{children:"测试工具"})]})},{href:"/test-tools/entity-topology",title:e.jsxs(M,{children:[e.jsx(ge,{}),e.jsx("span",{children:"实体拓扑"})]})},{title:s.name}]})}),e.jsx(At,{topologyData:s,onRefresh:k}),e.jsxs("div",{className:"topology-content",children:[e.jsx(kt,{entities:s.entities,dependencies:s.dependencies,onDeleteEntity:oe,onDeleteDependency:I,onAddEntity:Ze,onAddDependency:Z,onAgentsClick:z}),e.jsx("div",{className:"content-right",children:e.jsx(Dt,{entities:s.entities,dependencies:s.dependencies,onNodeSelect:t=>{if(t){const a=s.entities.find(d=>d.id===t.id);G(a||null)}else G(null)}})})]}),e.jsx(ye,{title:"确认删除实体",open:de,onOk:n,onCancel:l,okText:"确定删除",cancelText:"取消",okType:"danger",width:400,children:A&&s&&e.jsxs("div",{children:[e.jsxs("p",{children:["确定要删除实体 ",e.jsxs("strong",{children:['"',A.name,'"']})," 吗？"]}),(()=>{const t=s.dependencies.filter(a=>a.source===A.id||a.target===A.id);return t.length>0&&e.jsxs(Ot,{children:["删除后将同时移除 ",e.jsx("strong",{children:t.length})," 个相关的依赖关系。"]})})(),e.jsx(Be,{children:"此操作不可撤销，请谨慎操作。"})]})}),e.jsx(ye,{title:"确认删除依赖关系",open:se,onOk:h,onCancel:J,okText:"确定删除",cancelText:"取消",okType:"danger",width:400,children:L&&s&&e.jsx("div",{children:(()=>{const t=s.entities.find(u=>u.id===L.source),a=s.entities.find(u=>u.id===L.target),d=t?t.name:L.source,v=a?a.name:L.target;return e.jsxs(e.Fragment,{children:[e.jsx("p",{children:"确定要删除以下依赖关系吗？"}),e.jsxs(Mt,{children:[e.jsx("span",{className:"entity-name",children:d}),e.jsx("span",{className:"arrow",children:"→"}),e.jsx("span",{className:"entity-name",children:v})]}),e.jsxs(Wt,{children:["关系类型: ",L.description||L.type]}),e.jsx(Be,{children:"此操作不可撤销，请谨慎操作。"})]})})()})}),e.jsxs(ye,{title:"选择实体",open:je,onOk:Ke,onCancel:qe,okText:`确定添加 (${Y.length})`,cancelText:"取消",width:800,okButtonProps:{disabled:Y.length===0},children:[e.jsx(Le,{children:e.jsxs("p",{children:["从下列可用实体中选择要添加到拓扑图的实体。",X.length>0&&e.jsxs(e.Fragment,{children:["共有 ",e.jsx("span",{className:"highlight",children:X.length})," 个可用实体， 已选择"," ",e.jsx("span",{className:"highlight",children:Y.length})," 个。"]})]})}),X.length>0&&e.jsx("div",{style:{marginBottom:16},children:e.jsxs(M,{children:[e.jsx(R,{size:"small",onClick:Ve,disabled:Y.length===X.length,children:"全选"}),e.jsx(R,{size:"small",onClick:Ge,disabled:Y.length===0,children:"清空"})]})}),X.length===0?e.jsx(xe,{description:"暂无可添加的实体",image:xe.PRESENTED_IMAGE_SIMPLE}):e.jsx(ke,{rowSelection:{type:"checkbox",selectedRowKeys:Y,onChange:Fe},columns:[{title:"实体名称",dataIndex:"name",key:"name",width:"30%",render:t=>e.jsx("strong",{children:t})},{title:"类型",dataIndex:"type",key:"type",width:"25%",render:t=>e.jsx(q,{color:"blue",children:t.replace(/_/g," ")})},{title:"状态",dataIndex:"status",key:"status",width:"15%",render:t=>{const a={active:{color:"green",text:"正常"},warning:{color:"orange",text:"警告"},error:{color:"red",text:"错误"},inactive:{color:"gray",text:"停用"}},d=a[t]||a.active;return e.jsx(q,{color:d.color,children:d.text})}},{title:"描述",dataIndex:["properties","description"],key:"description",width:"30%",render:t=>e.jsx("span",{style:{color:"var(--text-secondary)"},children:t||"暂无描述"})}],dataSource:X,rowKey:"id",size:"small",pagination:{pageSize:8,showSizeChanger:!1,showQuickJumper:!0,showTotal:(t,a)=>`第 ${a[0]}-${a[1]} 条，共 ${t} 条`}})]}),e.jsxs(ye,{title:"创建依赖关系",open:he,onOk:ae,onCancel:le,okText:"建立关系",cancelText:"取消",width:600,okButtonProps:{disabled:!N||!D||N===D||(s==null?void 0:s.dependencies.find(t=>t.source===N&&t.target===D&&t.type===ee))!==void 0},children:[e.jsx(Le,{children:e.jsxs("p",{children:["选择源实体和目标实体来建立依赖关系。 当前拓扑中有"," ",e.jsx("span",{className:"highlight",children:(s==null?void 0:s.entities.length)||0})," 个实体可用。"]})}),e.jsxs(Zt,{children:[e.jsxs("div",{className:"form-item",children:[e.jsx("label",{className:"form-label",children:"源实体"}),e.jsx(Ne,{className:"entity-select",placeholder:"请选择源实体",value:N||void 0,onChange:ue,showSearch:!0,filterOption:(t,a)=>((a==null?void 0:a.label)??"").toLowerCase().includes(t.toLowerCase()),options:(s==null?void 0:s.entities.map(t=>({value:t.id,label:t.name,disabled:t.id===D})))||[]})]}),e.jsx("div",{style:{textAlign:"center",margin:"12px 0"},children:e.jsx(R,{type:"text",icon:e.jsx(pt,{}),onClick:Oe,disabled:!N&&!D,title:"交换源实体和目标实体",children:"交换"})}),e.jsxs("div",{className:"form-item",children:[e.jsx("label",{className:"form-label",children:"目标实体"}),e.jsx(Ne,{className:"entity-select",placeholder:"请选择目标实体",value:D||void 0,onChange:me,showSearch:!0,filterOption:(t,a)=>((a==null?void 0:a.label)??"").toLowerCase().includes(t.toLowerCase()),options:(s==null?void 0:s.entities.map(t=>({value:t.id,label:t.name,disabled:t.id===N})))||[]})]}),e.jsxs("div",{className:"form-item",children:[e.jsx("label",{className:"form-label",children:"关系类型"}),e.jsx(U.Group,{value:ee,onChange:t=>be(t.target.value),style:{width:"100%"},children:e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"repeat(3, 1fr)",gap:"8px"},children:[e.jsx(U,{value:"depends_on",children:"依赖于"}),e.jsx(U,{value:"connects_to",children:"连接到"}),e.jsx(U,{value:"uses",children:"使用"}),e.jsx(U,{value:"routes_to",children:"路由到"}),e.jsx(U,{value:"stores_in",children:"存储在"}),e.jsx(U,{value:"reads_from",children:"读取自"}),e.jsx(U,{value:"writes_to",children:"写入到"}),e.jsx(U,{value:"monitors",children:"监控"}),e.jsx(U,{value:"backs_up",children:"备份"})]})})]}),N&&D&&e.jsx(e.Fragment,{children:(()=>{var a,d;return(s==null?void 0:s.dependencies.find(v=>v.source===N&&v.target===D&&v.type===ee))?e.jsx("div",{style:{background:"var(--error-color)",color:"white",padding:"12px",borderRadius:"6px",margin:"16px 0",textAlign:"center"},children:"⚠️ 该依赖关系已存在"}):e.jsxs("div",{className:"relationship-preview",children:[e.jsxs("div",{className:"preview-content",children:[e.jsx("span",{className:"entity-name",children:(a=s==null?void 0:s.entities.find(v=>v.id===N))==null?void 0:a.name}),e.jsx("span",{className:"arrow",children:"→"}),e.jsx("span",{className:"entity-name",children:(d=s==null?void 0:s.entities.find(v=>v.id===D))==null?void 0:d.name})]}),e.jsxs("div",{className:"relationship-type",children:["关系类型: ",ce(ee)]})]})})()})]})]}),e.jsxs(ye,{title:"绑定Agent",open:Ce,onOk:E,onCancel:_,okText:`确定绑定 (${f.length})`,cancelText:"取消",width:900,okButtonProps:{disabled:f.length===0},children:[e.jsxs(Kt,{children:[e.jsx("p",{children:"为实体绑定AI Agent来提供智能化管理和监控能力。"}),r&&e.jsxs("div",{className:"entity-info",children:[e.jsx("span",{className:"entity-name",children:r.name}),e.jsxs("span",{className:"entity-type",children:["(",r.type,")"]})]}),e.jsxs("p",{style:{marginTop:8},children:["共有 ",e.jsx("span",{className:"highlight",children:y.length})," 个可用Agent， 已选择"," ",e.jsx("span",{className:"highlight",children:f.length})," 个。"]})]}),y.length>0&&e.jsx("div",{style:{marginBottom:16},children:e.jsxs(M,{children:[e.jsx(R,{size:"small",onClick:()=>j(y.map(t=>t.id)),disabled:f.length===y.length,children:"全选"}),e.jsx(R,{size:"small",onClick:()=>j([]),disabled:f.length===0,children:"清空"})]})}),y.length===0?e.jsx(xe,{description:"暂无可用的Agent",image:xe.PRESENTED_IMAGE_SIMPLE}):e.jsx(ke,{rowSelection:{type:"checkbox",selectedRowKeys:f,onChange:i},columns:[{title:"Agent名称",dataIndex:"name",key:"name",width:"25%",render:t=>e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:8},children:[e.jsx(gt,{style:{color:"var(--primary-color)"}}),e.jsx("strong",{children:t})]})},{title:"类型",dataIndex:"type",key:"type",width:"15%",render:t=>e.jsx(q,{color:"cyan",children:t})},{title:"状态",dataIndex:"status",key:"status",width:"12%",render:t=>{const a={active:{color:"green",text:"运行中"},warning:{color:"orange",text:"警告"},error:{color:"red",text:"错误"},inactive:{color:"gray",text:"停用"}},d=a[t]||a.active;return e.jsx(q,{color:d.color,children:d.text})}},{title:"能力",dataIndex:"capabilities",key:"capabilities",width:"25%",render:t=>e.jsxs("div",{children:[t.slice(0,2).map((a,d)=>e.jsx(q,{size:"small",style:{marginBottom:2},children:a},d)),t.length>2&&e.jsxs(q,{size:"small",color:"default",children:["+",t.length-2]})]})},{title:"描述",dataIndex:"description",key:"description",width:"23%",render:t=>e.jsx("span",{style:{color:"var(--text-secondary)",fontSize:"12px"},children:t})}],dataSource:y,rowKey:"id",size:"small",pagination:{pageSize:6,showSizeChanger:!1,showQuickJumper:!0,showTotal:(t,a)=>`第 ${a[0]}-${a[1]} 条，共 ${t} 条`}})]})]}):e.jsx("div",{className:"entity-topology-detail-empty",children:e.jsx(xe,{description:"拓扑数据不存在"})})};export{Jt as default};
