import React, { useState, useEffect } from 'react';
import {
  Typography,
  Card,
  Space,
  Button,
  Row,
  Col,
  Statistic,
  Tag,
  Modal,
  Form,
  Input,
  Select,
  Switch,
  Slider,
  message,
  Descriptions,
  Timeline,
  Pagination,
  Spin
} from 'antd';
import {
  RobotOutlined,
  PlusOutlined,
  ReloadOutlined,
  DeleteOutlined,
  PlayCircleOutlined,
  ThunderboltOutlined,
  CheckCircleOutlined,
  ExclamationCircleOutlined,
  ApiOutlined,
  MonitorOutlined,
  BarChartOutlined
} from '@ant-design/icons';
import styled from 'styled-components';
import { useNavigate } from 'react-router-dom';
import { useTranslation } from 'react-i18next';
import { setPageTitle } from '../../utils';
import { useAppSelector } from '../../store';
import SearchFilterBar from '../../components/Common/SearchFilterBar';
import { AgentCard, AgentDetail, type Agent } from '../../components/AgentCard';
import { AIAgentApi, type AIAgentResponse, type AIAgentStatisticsResponse, type QueryAIAgentRequest } from '../../services/aiAgentApi';
import '../../styles/ai-agent-management.css';

const { Title, Paragraph, Text } = Typography;
const { Option } = Select;
const { TextArea } = Input;

const PageContainer = styled.div<{ $isDark: boolean }>`
  padding: 24px;
  min-height: calc(100vh - 64px);
  background: ${props => (props.$isDark ? '#000000' : '#f5f5f5')};
`;

const StatsCard = styled(Card)<{ $isDark: boolean }>`
  border-radius: 8px;
  box-shadow: ${props => (props.$isDark ? '0 2px 8px rgba(255, 255, 255, 0.05)' : '0 2px 8px rgba(0, 0, 0, 0.06)')};
  border: ${props => (props.$isDark ? '1px solid #303030' : '1px solid #f0f0f0')};
  background: ${props => (props.$isDark ? '#141414' : '#ffffff')};

  .ant-card-body {
    padding: 16px;
  }

  .ant-statistic-title {
    color: ${props => (props.$isDark ? '#ffffff' : '#666666')};
  }

  .ant-statistic-content {
    color: ${props => (props.$isDark ? '#ffffff' : '#262626')};
  }
`;

const StatusDot = styled.div<{ status: string }>`
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background-color: ${props => {
    switch (props.status) {
      case 'running':
        return '#52c41a';
      case 'stopped':
        return '#f5222d';
      case 'paused':
        return '#faad14';
      default:
        return '#d9d9d9';
    }
  }};
  display: inline-block;
  margin-right: 8px;
`;

interface AIAgent {
  id: string;
  name: string;
  type: 'monitor' | 'analysis' | 'deployment' | 'optimization';
  status: 'running' | 'stopped' | 'paused';
  description: string;
  version: string;
  cpu: number;
  memory: number;
  tasks: number;
  successRate: number;
  lastActive: string;
  createdAt: string;
  config: {
    maxConcurrency: number;
    timeout: number;
    retryCount: number;
    autoRestart: boolean;
  };
}

const AIAgentManagement: React.FC = () => {
  const navigate = useNavigate();
  const { t } = useTranslation(['agents', 'common']);
  const [modalVisible, setModalVisible] = useState(false);
  const [detailModalVisible, setDetailModalVisible] = useState(false);
  const [selectedAgent, setSelectedAgent] = useState<AIAgentResponse | null>(null);
  const [searchText, setSearchText] = useState('');
  const [filterStatus, setFilterStatus] = useState('all');
  const [filterType, setFilterType] = useState('all');
  const [resetLoading, setResetLoading] = useState(false);
  const [form] = Form.useForm();
  const { currentTheme } = useAppSelector(state => state.theme);
  
  // Êï∞ÊçÆÁä∂ÊÄÅ
  const [agentData, setAgentData] = useState<AIAgentResponse[]>([]);
  const [statistics, setStatistics] = useState<AIAgentStatisticsResponse | null>(null);
  const [loading, setLoading] = useState(false);
  const [statsLoading, setStatsLoading] = useState(false);
  
  // ÂàÜÈ°µÁä∂ÊÄÅ
  const [pagination, setPagination] = useState(() => {
    // ‰ªélocalStorageËØªÂèñÁî®Êà∑ÁöÑÂàÜÈ°µÂÅèÂ•Ω
    const savedPageSize = localStorage.getItem('ai-agent-page-size');
    return {
      current: 1,
      pageSize: savedPageSize ? parseInt(savedPageSize, 10) : 6,
      total: 0
    };
  });
  
  const isDark = currentTheme === 'dark';

  // ÈáçÁΩÆÂàÜÈ°µÂà∞Á¨¨‰∏ÄÈ°µÔºàÁî®‰∫éÊêúÁ¥¢ÂíåÁ≠õÈÄâÊó∂Ôºâ
  const resetPagination = () => {
    setPagination(prev => ({
      ...prev,
      current: 1
    }));
  };

  useEffect(() => {
    setPageTitle(t('agents:title'));
  }, [t]);

  // ÂΩìÊêúÁ¥¢Êù°‰ª∂ÊàñÁ≠õÈÄâÊù°‰ª∂ÂèòÂåñÊó∂ÔºåÈáçÁΩÆÂàÜÈ°µÂà∞Á¨¨‰∏ÄÈ°µ
  useEffect(() => {
    resetPagination();
  }, [searchText, filterStatus, filterType]);

  // Âä†ËΩΩÊô∫ËÉΩ‰ΩìÂàóË°®
  const loadAgentList = async () => {
    setLoading(true);
    try {
      const params: QueryAIAgentRequest = {
        page: pagination.current,
        size: pagination.pageSize,
        search: searchText || undefined,
        type: filterType !== 'all' ? filterType as any : undefined,
        status: filterStatus !== 'all' ? filterStatus as any : undefined,
      };

      const response = await AIAgentApi.getAIAgentList(params);
      
      console.log('üîç ÂìçÂ∫îÊ£ÄÊü•:', {
        'response.success': response.success,
        'response.data': response.data,
        'response.dataÂ≠òÂú®': !!response.data,
        'Êù°‰ª∂ÁªìÊûú': response.success && response.data,
        'ÂÆåÊï¥ÂìçÂ∫î': response
      });
      
      if (response.success && response.data) {
        setAgentData(response.data.data);
        setPagination(prev => ({
          ...prev,
          total: typeof response.data.total === 'string' ? parseInt(response.data.total, 10) : response.data.total
        }));
        console.log('‚úÖ ÊàêÂäüÂä†ËΩΩÊô∫ËÉΩ‰ΩìÂàóË°®:', response.data.data.length, '‰∏™Êô∫ËÉΩ‰ΩìÔºåÊÄªËÆ°:', response.data.total);
      } else {
        console.warn('‚ö†Ô∏è Âä†ËΩΩÊô∫ËÉΩ‰ΩìÂàóË°®Â§±Ë¥•:', response.message);
        message.warning('Âä†ËΩΩÊô∫ËÉΩ‰ΩìÂàóË°®Â§±Ë¥•: ' + response.message);
        setAgentData([]);
      }
    } catch (error) {
      console.error('‚ùå Âä†ËΩΩÊô∫ËÉΩ‰ΩìÂàóË°®ÂºÇÂ∏∏:', error);
      message.error('Âä†ËΩΩÊô∫ËÉΩ‰ΩìÂàóË°®Â§±Ë¥•: ' + (error instanceof Error ? error.message : 'Êú™Áü•ÈîôËØØ'));
      setAgentData([]);
    } finally {
      setLoading(false);
    }
  };

  // Âä†ËΩΩÁªüËÆ°Êï∞ÊçÆ
  const loadStatistics = async () => {
    setStatsLoading(true);
    try {
      const response = await AIAgentApi.getAIAgentStatistics();
      
      console.log('üîç ÁªüËÆ°ÂìçÂ∫îÊ£ÄÊü•:', {
        'response.success': response.success,
        'response.data': response.data,
        'response.dataÂ≠òÂú®': !!response.data,
        'Êù°‰ª∂ÁªìÊûú': response.success && response.data,
        'ÂÆåÊï¥ÂìçÂ∫î': response
      });
      
      if (response.success && response.data) {
        setStatistics(response.data);
        console.log('‚úÖ ÊàêÂäüÂä†ËΩΩÁªüËÆ°Êï∞ÊçÆ:', response.data);
      } else {
        console.warn('‚ö†Ô∏è Âä†ËΩΩÁªüËÆ°Êï∞ÊçÆÂ§±Ë¥•:', response.message);
        message.warning('Âä†ËΩΩÁªüËÆ°Êï∞ÊçÆÂ§±Ë¥•: ' + response.message);
      }
    } catch (error) {
      console.error('‚ùå Âä†ËΩΩÁªüËÆ°Êï∞ÊçÆÂºÇÂ∏∏:', error);
      message.error('Âä†ËΩΩÁªüËÆ°Êï∞ÊçÆÂ§±Ë¥•: ' + (error instanceof Error ? error.message : 'Êú™Áü•ÈîôËØØ'));
    } finally {
      setStatsLoading(false);
    }
  };

  // ÂàùÂßãÂåñÊï∞ÊçÆÂä†ËΩΩ
  useEffect(() => {
    loadAgentList();
    loadStatistics();
  }, [pagination.current, pagination.pageSize, searchText, filterStatus, filterType]);

  // Âà∑Êñ∞Êï∞ÊçÆ
  const handleRefresh = async () => {
    setResetLoading(true);
    try {
      await Promise.all([loadAgentList(), loadStatistics()]);
      message.success('Êï∞ÊçÆÂà∑Êñ∞ÊàêÂäü');
    } catch (error) {
      message.error('Êï∞ÊçÆÂà∑Êñ∞Â§±Ë¥•');
    } finally {
      setResetLoading(false);
    }
  };

  // ÂàõÂª∫Êô∫ËÉΩ‰Ωì
  const handleCreateAgent = () => {
    navigate('/ai-agents/create');
  };

  // ÊêúÁ¥¢Â§ÑÁêÜ
  const handleSearch = (value: string) => {
    setSearchText(value);
  };

  // ÁºñËæëÊô∫ËÉΩ‰Ωì
  const handleEditAgent = (agent: AIAgentResponse) => {
    navigate(`/ai-agents/edit/${agent.id}`);
  };

  // ÂàÜÈ°µÂèòÊõ¥Â§ÑÁêÜ
  const handlePaginationChange = (page: number, pageSize?: number) => {
    const newPageSize = pageSize || pagination.pageSize;
    
    setPagination(prev => ({
      ...prev,
      current: page,
      pageSize: newPageSize
    }));
    
    // ‰øùÂ≠òÁî®Êà∑ÁöÑÂàÜÈ°µÂÅèÂ•Ω
    if (pageSize && pageSize !== pagination.pageSize) {
      localStorage.setItem('ai-agent-page-size', pageSize.toString());
    }
    
    // ÊªöÂä®Âà∞È°µÈù¢È°∂ÈÉ®
    window.scrollTo({ top: 0, behavior: 'smooth' });
  };

  // ÈáçÁΩÆÊâÄÊúâÁ≠õÈÄâÊù°‰ª∂
  const handleResetFilters = async () => {
    setResetLoading(true);
    
    try {
      // ÈáçÁΩÆÊêúÁ¥¢ÂíåÁ≠õÈÄâÊù°‰ª∂
      setSearchText('');
      setFilterStatus('all');
      setFilterType('all');
      
      // ÂÆåÂÖ®ÈáçÁΩÆÂàÜÈ°µÁä∂ÊÄÅ
      const savedPageSize = localStorage.getItem('ai-agent-page-size');
      setPagination({
        current: 1,
        pageSize: savedPageSize ? parseInt(savedPageSize, 10) : 6,
        total: 0 // Â∞ÜÂú®Êï∞ÊçÆÂä†ËΩΩÂêéÊõ¥Êñ∞
      });
      
      // Ê®°Êãü‰∏Ä‰∏™Áü≠ÊöÇÁöÑÂª∂ËøüÔºåÊèê‰æõÊõ¥Â•ΩÁöÑÁî®Êà∑ÂèçÈ¶à
      await new Promise(resolve => setTimeout(resolve, 300));
      
    } finally {
      setResetLoading(false);
    }
  };

  const agentTypeMap = {
    monitor: { name: t('agents:types.monitor'), color: 'blue', icon: <MonitorOutlined /> },
    analysis: { name: t('agents:types.analysis'), color: 'green', icon: <BarChartOutlined /> },
    deployment: { name: t('agents:types.deployment'), color: 'purple', icon: <ApiOutlined /> },
    optimization: { name: t('agents:types.optimization'), color: 'orange', icon: <ThunderboltOutlined /> },
    security: { name: t('agents:types.security'), color: 'red', icon: <ExclamationCircleOutlined /> },
    backup: { name: t('agents:types.backup'), color: 'cyan', icon: <CheckCircleOutlined /> },
    gateway: { name: t('agents:types.gateway'), color: 'geekblue', icon: <ApiOutlined /> },
    planning: { name: t('agents:types.planning'), color: 'magenta', icon: <BarChartOutlined /> },
    diagnosis: { name: t('agents:types.diagnosis'), color: 'volcano', icon: <MonitorOutlined /> },
    config: { name: t('agents:types.config'), color: 'lime', icon: <ApiOutlined /> },
    traffic: { name: t('agents:types.traffic'), color: 'gold', icon: <BarChartOutlined /> },
    cleanup: { name: t('agents:types.cleanup'), color: 'gray', icon: <DeleteOutlined /> }
  };

  const getStatusTag = (status: string) => {
    const statusMap = {
      running: {
        color: isDark ? '#52c41a' : 'green',
        text: t('agents:status.running'),
        bgColor: isDark ? 'rgba(82, 196, 26, 0.1)' : undefined
      },
      stopped: {
        color: isDark ? '#f5222d' : 'red',
        text: t('agents:status.stopped'),
        bgColor: isDark ? 'rgba(245, 34, 45, 0.1)' : undefined
      },
      paused: {
        color: isDark ? '#faad14' : 'orange',
        text: t('agents:status.paused'),
        bgColor: isDark ? 'rgba(250, 173, 20, 0.1)' : undefined
      }
    };
    const config = statusMap[status as keyof typeof statusMap];
    return (
      <Tag
        color={config.color}
        style={
          config.bgColor
            ? {
                backgroundColor: config.bgColor,
                border: `1px solid ${config.color}`,
                color: config.color
              }
            : {}
        }
      >
        <StatusDot status={status} />
        {config.text}
      </Tag>
    );
  };

  const handleViewAgent = (agent: AIAgentResponse) => {
    setSelectedAgent(agent);
    setDetailModalVisible(true);
  };

  const handleStartAgent = async (agentId: string) => {
    try {
      // ËøôÈáåÂèØ‰ª•Ë∞ÉÁî®ÂêØÂä®Êô∫ËÉΩ‰ΩìÁöÑAPI
      message.success('Êô∫ËÉΩ‰ΩìÂêØÂä®ÊàêÂäü');
      // ÈáçÊñ∞Âä†ËΩΩÊï∞ÊçÆ
      await loadAgentList();
    } catch (error) {
      message.error(`ÂêØÂä®Êô∫ËÉΩ‰ΩìÂ§±Ë¥•: ${error instanceof Error ? error.message : 'Êú™Áü•ÈîôËØØ'}`);
    }
  };

  const handleStopAgent = async (agentId: string) => {
    try {
      // ËøôÈáåÂèØ‰ª•Ë∞ÉÁî®ÂÅúÊ≠¢Êô∫ËÉΩ‰ΩìÁöÑAPI
      message.success('Êô∫ËÉΩ‰ΩìÂÅúÊ≠¢ÊàêÂäü');
      // ÈáçÊñ∞Âä†ËΩΩÊï∞ÊçÆ
      await loadAgentList();
    } catch (error) {
      message.error(`ÂÅúÊ≠¢Êô∫ËÉΩ‰ΩìÂ§±Ë¥•: ${error instanceof Error ? error.message : 'Êú™Áü•ÈîôËØØ'}`);
    }
  };

  const handleDeleteAgent = async (agentId: string) => {
    const agent = agentData.find(a => a.id === agentId);
    if (!agent) return;

    Modal.confirm({
      title: 'Á°ÆËÆ§Âà†Èô§',
      content: `Á°ÆÂÆöË¶ÅÂà†Èô§Êô∫ËÉΩ‰Ωì "${agent.name}" ÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊÅ¢Â§ç„ÄÇ`,
      okText: 'Á°ÆËÆ§Âà†Èô§',
      okType: 'danger',
      cancelText: 'ÂèñÊ∂à',
      onOk: async () => {
        try {
          const response = await AIAgentApi.deleteAIAgent({ id: agentId });
          if (response.success) {
            message.success(`Êô∫ËÉΩ‰Ωì "${agent.name}" Âà†Èô§ÊàêÂäü`);
            // ÈáçÊñ∞Âä†ËΩΩÊï∞ÊçÆ
            await loadAgentList();
            await loadStatistics();
          } else {
            message.error(`Âà†Èô§Â§±Ë¥•: ${response.message}`);
          }
        } catch (error) {
          message.error(`Âà†Èô§Êô∫ËÉΩ‰ΩìÂ§±Ë¥•: ${error instanceof Error ? error.message : 'Êú™Áü•ÈîôËØØ'}`);
        }
      }
    });
  };

  const handleModalOk = async () => {
    try {
      const _values = await form.validateFields();
      message.success('Êô∫ËÉΩ‰ΩìÂàõÂª∫ÊàêÂäü');
      setModalVisible(false);
      form.resetFields();
      // ÈáçÊñ∞Âä†ËΩΩÊï∞ÊçÆ
      await loadAgentList();
      await loadStatistics();
    } catch (error) {
      console.error('Ë°®ÂçïÈ™åËØÅÂ§±Ë¥•:', error);
    }
  };

  const renderAgentCards = () => {
    // Áõ¥Êé•‰ΩøÁî®‰ªéAPIËé∑ÂèñÁöÑÊï∞ÊçÆÔºåÊó†ÈúÄÂâçÁ´ØÁ≠õÈÄâÂíåÂàÜÈ°µ
    return agentData.map(agent => (
      <Col xs={24} sm={24} lg={12} xl={8} key={agent.id}>
        <AgentCard
          agent={
            {
              id: agent.id,
              name: agent.name,
              type: agent.type as any,
              status: agent.status as any,
              description: agent.description,
              version: agent.model?.version || 'v1.0.0',
              cpu: agent.runtime?.cpu || 0,
              memory: agent.runtime?.memory || 0,
              tasks: agent.runtime?.tasks || 0,
              successRate: agent.runtime?.successRate || 0,
              lastActive: agent.runtime?.lastActive || agent.updatedAt,
              createdAt: agent.createdAt,
              config: {
                maxConcurrency: agent.settings?.maxConcurrency || 1,
                timeout: agent.settings?.timeout || 30,
                retryCount: agent.settings?.retryCount || 3,
                autoRestart: agent.settings?.autoStart || false
              },
              stats: {
                tasksCompleted: agent.runtime?.tasks || 0,
                successRate: agent.runtime?.successRate || 0,
                avgResponseTime: Math.floor(Math.random() * 200) + 100,
                uptime: agent.runtime?.uptime ? `${Math.floor(agent.runtime.uptime / 3600)}Â∞èÊó∂` : '0Â∞èÊó∂'
              }
            } as Agent
          }
          onEdit={handleEditAgent}
          onDelete={handleDeleteAgent}
          onStart={handleStartAgent}
          onStop={handleStopAgent}
          onView={handleViewAgent}
        />
      </Col>
    ));
  };

  // ‰ΩøÁî®ÁªüËÆ°Êï∞ÊçÆÊàñ‰ªéÂΩìÂâçÊï∞ÊçÆËÆ°ÁÆó
  const runningAgents = statistics?.activeAgents || agentData.filter(agent => agent.status === 'active').length;
  const totalTasks = statistics?.totalTasks || agentData.reduce((sum, agent) => sum + (agent.runtime?.tasks || 0), 0);
  const avgSuccessRate = statistics?.avgSuccessRate || (agentData.length > 0 ? agentData.reduce((sum, agent) => sum + (agent.runtime?.successRate || 0), 0) / agentData.length : 0);

  return (
    <PageContainer $isDark={isDark} className="ai-agent-management-page">
      {/* TitleÂíåÊåâÈíÆÂú®Âêå‰∏ÄË°å */}
      <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 8 }}>
        <Title level={2} style={{ margin: 0 }}>
          <Space>
            <RobotOutlined />
            {t('agents:title')}
          </Space>
        </Title>
        <Space>
          <Button 
            icon={<ReloadOutlined />} 
            loading={resetLoading}
            onClick={handleRefresh}
          >
            {t('common:refresh')}
          </Button>
          <Button type="primary" icon={<PlusOutlined />} onClick={handleCreateAgent}>
            {t('agents:createAgent')}
          </Button>
        </Space>
      </div>

      {/* ParagraphÂçïÁã¨‰∏ÄË°åÔºåÂÖÖÊª°ÂÆΩÂ∫¶ */}
      <Paragraph
        style={{
          marginTop: 0,
          marginBottom: 24
        }}
      >
        {t('agents:subtitle')}
      </Paragraph>

      {/* ÁªüËÆ°‰ø°ÊÅØ */}
      <Spin spinning={statsLoading}>
        <Row gutter={16} style={{ marginBottom: 24 }}>
          <Col xs={24} sm={12} md={6}>
            <StatsCard $isDark={isDark} className="agent-stats-primary">
              <Statistic 
                title={t('agents:stats.totalAgents')} 
                value={statistics?.totalAgents || agentData.length} 
                prefix={<RobotOutlined />} 
              />
            </StatsCard>
          </Col>
          <Col xs={24} sm={12} md={6}>
            <StatsCard $isDark={isDark} className="agent-stats-success">
              <Statistic 
                title={t('agents:stats.runningAgents')} 
                value={runningAgents} 
                prefix={<PlayCircleOutlined />} 
              />
            </StatsCard>
          </Col>
          <Col xs={24} sm={12} md={6}>
            <StatsCard $isDark={isDark} className="agent-stats-warning">
              <Statistic 
                title={t('agents:stats.totalTasks')} 
                value={totalTasks} 
                prefix={<ThunderboltOutlined />} 
              />
            </StatsCard>
          </Col>
          <Col xs={24} sm={12} md={6}>
            <StatsCard $isDark={isDark} className="agent-stats-purple">
              <Statistic
                title={t('agents:stats.avgSuccessRate')}
                value={avgSuccessRate.toFixed(1)}
                prefix={<CheckCircleOutlined />}
                suffix="%"
              />
            </StatsCard>
          </Col>
        </Row>
      </Spin>

      {/* ÊêúÁ¥¢ÂíåÁ≠õÈÄâÂå∫Âüü */}
      <SearchFilterBar
        searchValue={searchText}
        onSearchChange={handleSearch}
        searchPlaceholder={t('agents:searchPlaceholder')}
        showRefresh={true}
        onRefresh={handleResetFilters}
        refreshLoading={resetLoading}
        filters={[
          {
            key: 'status',
            value: filterStatus,
            onChange: setFilterStatus,
            placeholder: t('agents:filterByStatus'),
            width: 120,
            options: [
              { value: 'all', label: t('common:all') },
              { value: 'active', label: 'Ê¥ªË∑É' },
              { value: 'inactive', label: 'ÈùûÊ¥ªË∑É' },
              { value: 'training', label: 'ËÆ≠ÁªÉ‰∏≠' }
            ]
          },
          {
            key: 'type',
            value: filterType,
            onChange: setFilterType,
            placeholder: t('agents:filterByType'),
            width: 140,
            options: [
              { value: 'all', label: t('common:all') },
              { value: 'chat', label: 'ÂØπËØùÂûã' },
              { value: 'task', label: '‰ªªÂä°Âûã' },
              { value: 'analysis', label: 'ÂàÜÊûêÂûã' },
              { value: 'monitoring', label: 'ÁõëÊéßÂûã' }
            ]
          }
        ]}
      />

      {/* Êô∫ËÉΩ‰ΩìÂç°ÁâáÂ±ïÁ§∫ */}
      <div style={{ minHeight: '400px', position: 'relative' }}>
        <Spin spinning={loading} size="large">
          <Row gutter={[16, 16]}>
            {agentData.length === 0 && !loading ? (
              <Col span={24}>
                <Card style={{ textAlign: 'center', padding: '40px 20px' }}>
                  <RobotOutlined style={{ fontSize: '48px', color: '#d9d9d9', marginBottom: '16px' }} />
                  <Title level={4} type="secondary">
                    {searchText || filterStatus !== 'all' || filterType !== 'all' 
                      ? 'Êú™ÊâæÂà∞ÂåπÈÖçÁöÑÊô∫ËÉΩ‰Ωì' 
                      : 'ÊöÇÊó†Êô∫ËÉΩ‰Ωì'
                    }
                  </Title>
                  <Paragraph type="secondary">
                    {searchText || filterStatus !== 'all' || filterType !== 'all' 
                      ? 'ËØ∑Â∞ùËØïË∞ÉÊï¥ÊêúÁ¥¢Êù°‰ª∂ÊàñÁ≠õÈÄâÂô®„ÄÇ' 
                      : 'ÁÇπÂáªÂè≥‰∏äËßíÁöÑ"ÂàõÂª∫Êô∫ËÉΩ‰Ωì"ÊåâÈíÆÂºÄÂßãÂàõÂª∫ÊÇ®ÁöÑÁ¨¨‰∏Ä‰∏™AIÊô∫ËÉΩ‰Ωì„ÄÇ'
                    }
                  </Paragraph>
                  {(!searchText && filterStatus === 'all' && filterType === 'all') && (
                    <Button type="primary" icon={<PlusOutlined />} onClick={handleCreateAgent}>
                      ÂàõÂª∫Êô∫ËÉΩ‰Ωì
                    </Button>
                  )}
                </Card>
              </Col>
            ) : (
              renderAgentCards()
            )}
          </Row>
        </Spin>
      </div>

      {/* ÂàÜÈ°µÁªÑ‰ª∂ */}
      {pagination.total > 0 && (
        <Row justify="center" style={{ marginTop: 32, marginBottom: 24 }}>
          <Col>
            <Pagination
              current={pagination.current}
              pageSize={pagination.pageSize}
              total={pagination.total}
              onChange={handlePaginationChange}
              onShowSizeChange={handlePaginationChange}
              showSizeChanger
              showQuickJumper={pagination.total > 50}
              showTotal={(total, range) => 
                `Á¨¨ ${range[0]}-${range[1]} Êù°ÔºåÂÖ± ${total} ‰∏™Êô∫ËÉΩ‰Ωì`
              }
              pageSizeOptions={['6', '12', '18', '24']}
              disabled={loading}
            />
          </Col>
        </Row>
      )}

      {/* Êô∫ËÉΩ‰ΩìËØ¶ÊÉÖÊ®°ÊÄÅÊ°Ü */}
      <Modal
        title="Êô∫ËÉΩ‰ΩìËØ¶ÊÉÖ"
        open={detailModalVisible}
        onCancel={() => setDetailModalVisible(false)}
        footer={null}
        width={800}
      >
        {selectedAgent && (
          <AgentDetail agent={selectedAgent} />
        )}
      </Modal>

      {/* ÂàõÂª∫Êô∫ËÉΩ‰ΩìÊ®°ÊÄÅÊ°Ü */}
      <Modal
        title={t('agents:createAgent')}
        open={modalVisible}
        onOk={handleModalOk}
        onCancel={() => setModalVisible(false)}
        width={800}
      >
        <Form
          form={form}
          layout="vertical"
          initialValues={{
            type: 'monitor',
            maxConcurrency: 5,
            timeout: 60,
            retryCount: 3,
            autoRestart: true
          }}
        >
          <Row gutter={16}>
            <Col span={12}>
              <Form.Item
                name="name"
                label="Êô∫ËÉΩ‰ΩìÂêçÁß∞"
                rules={[
                  { required: true, message: 'ËØ∑ËæìÂÖ•Êô∫ËÉΩ‰ΩìÂêçÁß∞' },
                  { max: 50, message: 'ÂêçÁß∞‰∏çËÉΩË∂ÖËøá50‰∏™Â≠óÁ¨¶' }
                ]}
              >
                <Input placeholder="ËØ∑ËæìÂÖ•Êô∫ËÉΩ‰ΩìÂêçÁß∞" />
              </Form.Item>
            </Col>
            <Col span={12}>
              <Form.Item name="type" label="Êô∫ËÉΩ‰ΩìÁ±ªÂûã" rules={[{ required: true, message: 'ËØ∑ÈÄâÊã©Êô∫ËÉΩ‰ΩìÁ±ªÂûã' }]}>
                <Select placeholder="ËØ∑ÈÄâÊã©Á±ªÂûã">
                  {Object.entries(agentTypeMap).map(([key, config]) => (
                    <Option key={key} value={key}>
                      <Space>
                        {config.icon}
                        {config.name}
                      </Space>
                    </Option>
                  ))}
                </Select>
              </Form.Item>
            </Col>
          </Row>

          <Form.Item
            name="description"
            label="ÊèèËø∞"
            rules={[
              { required: true, message: 'ËØ∑ËæìÂÖ•Êô∫ËÉΩ‰ΩìÊèèËø∞' },
              { max: 200, message: 'ÊèèËø∞‰∏çËÉΩË∂ÖËøá200‰∏™Â≠óÁ¨¶' }
            ]}
          >
            <TextArea rows={3} placeholder="ËØ∑ËæìÂÖ•Êô∫ËÉΩ‰ΩìÁöÑÂäüËÉΩÊèèËø∞" />
          </Form.Item>

          <Row gutter={16}>
            <Col span={12}>
              <Form.Item
                name="maxConcurrency"
                label="ÊúÄÂ§ßÂπ∂ÂèëÊï∞"
                rules={[{ required: true, message: 'ËØ∑ËÆæÁΩÆÊúÄÂ§ßÂπ∂ÂèëÊï∞' }]}
              >
                <Slider
                  min={1}
                  max={20}
                  marks={{
                    1: '1',
                    5: '5',
                    10: '10',
                    20: '20'
                  }}
                />
              </Form.Item>
            </Col>
            <Col span={12}>
              <Form.Item name="timeout" label="Ë∂ÖÊó∂Êó∂Èó¥(Áßí)" rules={[{ required: true, message: 'ËØ∑ËÆæÁΩÆË∂ÖÊó∂Êó∂Èó¥' }]}>
                <Slider
                  min={10}
                  max={300}
                  marks={{
                    10: '10s',
                    60: '1m',
                    180: '3m',
                    300: '5m'
                  }}
                />
              </Form.Item>
            </Col>
          </Row>

          <Row gutter={16}>
            <Col span={12}>
              <Form.Item name="retryCount" label="ÈáçËØïÊ¨°Êï∞" rules={[{ required: true, message: 'ËØ∑ËÆæÁΩÆÈáçËØïÊ¨°Êï∞' }]}>
                <Select>
                  <Option value={0}>‰∏çÈáçËØï</Option>
                  <Option value={1}>1Ê¨°</Option>
                  <Option value={2}>2Ê¨°</Option>
                  <Option value={3}>3Ê¨°</Option>
                  <Option value={5}>5Ê¨°</Option>
                </Select>
              </Form.Item>
            </Col>
            <Col span={12}>
              <Form.Item name="autoRestart" label="Ëá™Âä®ÈáçÂêØ" valuePropName="checked">
                <Switch />
              </Form.Item>
            </Col>
          </Row>
        </Form>
      </Modal>

      {/* Êô∫ËÉΩ‰ΩìËØ¶ÊÉÖÊ®°ÊÄÅÊ°Ü */}
      <Modal
        title={<span style={{ color: isDark ? '#ffffff' : '#262626' }}>Êô∫ËÉΩ‰ΩìËØ¶ÊÉÖ</span>}
        open={detailModalVisible}
        onCancel={() => setDetailModalVisible(false)}
        footer={null}
        width={800}
        styles={{
          content: {
            backgroundColor: isDark ? '#141414' : '#ffffff',
            color: isDark ? '#ffffff' : '#000000'
          }
        }}
      >
        {selectedAgent && (
          <div>
            <Descriptions
              bordered
              column={2}
              labelStyle={{
                backgroundColor: isDark ? '#1f1f1f' : '#fafafa',
                color: isDark ? '#ffffff' : '#262626'
              }}
              contentStyle={{
                backgroundColor: isDark ? '#141414' : '#ffffff',
                color: isDark ? '#ffffff' : '#262626'
              }}
            >
              <Descriptions.Item label="ÂêçÁß∞">{selectedAgent.name}</Descriptions.Item>
              <Descriptions.Item label="ÁâàÊú¨">{selectedAgent.version}</Descriptions.Item>
              <Descriptions.Item label="Á±ªÂûã">
                {agentTypeMap[selectedAgent.type as keyof typeof agentTypeMap]?.name}
              </Descriptions.Item>
              <Descriptions.Item label="Áä∂ÊÄÅ">{getStatusTag(selectedAgent.status)}</Descriptions.Item>
              <Descriptions.Item label="CPU‰ΩøÁî®Áéá">{selectedAgent.cpu}%</Descriptions.Item>
              <Descriptions.Item label="ÂÜÖÂ≠ò‰ΩøÁî®">{selectedAgent.memory}MB</Descriptions.Item>
              <Descriptions.Item label="ÊâßË°å‰ªªÂä°">{selectedAgent.tasks}Ê¨°</Descriptions.Item>
              <Descriptions.Item label="ÊàêÂäüÁéá">{selectedAgent.successRate}%</Descriptions.Item>
              <Descriptions.Item label="ÂàõÂª∫Êó∂Èó¥" span={2}>
                {selectedAgent.createdAt}
              </Descriptions.Item>
              <Descriptions.Item label="ÊèèËø∞" span={2}>
                {selectedAgent.description}
              </Descriptions.Item>
            </Descriptions>

            <div style={{ marginTop: 24 }}>
              <Title level={4} style={{ color: isDark ? '#ffffff' : '#262626' }}>
                ÈÖçÁΩÆ‰ø°ÊÅØ
              </Title>
              <Descriptions
                bordered
                column={2}
                labelStyle={{
                  backgroundColor: isDark ? '#1f1f1f' : '#fafafa',
                  color: isDark ? '#ffffff' : '#262626'
                }}
                contentStyle={{
                  backgroundColor: isDark ? '#141414' : '#ffffff',
                  color: isDark ? '#ffffff' : '#262626'
                }}
              >
                <Descriptions.Item label="ÊúÄÂ§ßÂπ∂Âèë">{selectedAgent.config.maxConcurrency}</Descriptions.Item>
                <Descriptions.Item label="Ë∂ÖÊó∂Êó∂Èó¥">{selectedAgent.config.timeout}Áßí</Descriptions.Item>
                <Descriptions.Item label="ÈáçËØïÊ¨°Êï∞">{selectedAgent.config.retryCount}Ê¨°</Descriptions.Item>
                <Descriptions.Item label="Ëá™Âä®ÈáçÂêØ">
                  {selectedAgent.config.autoRestart ? 'ÂêØÁî®' : 'Á¶ÅÁî®'}
                </Descriptions.Item>
              </Descriptions>
            </div>

            <div style={{ marginTop: 24 }}>
              <Title level={4} style={{ color: isDark ? '#ffffff' : '#262626' }}>
                ËøêË°åÊó•Âøó
              </Title>
              <Timeline>
                <Timeline.Item color="green">
                  <Text strong style={{ color: isDark ? '#ffffff' : '#262626' }}>
                    14:30:25
                  </Text>
                  <span style={{ color: isDark ? '#8c8c8c' : '#666666' }}> - Êô∫ËÉΩ‰ΩìÂêØÂä®ÊàêÂäü</span>
                </Timeline.Item>
                <Timeline.Item color="blue">
                  <Text strong style={{ color: isDark ? '#ffffff' : '#262626' }}>
                    14:28:10
                  </Text>
                  <span style={{ color: isDark ? '#8c8c8c' : '#666666' }}> - ÊâßË°åÁõëÊéß‰ªªÂä° #1247</span>
                </Timeline.Item>
                <Timeline.Item color="blue">
                  <Text strong style={{ color: isDark ? '#ffffff' : '#262626' }}>
                    14:25:30
                  </Text>
                  <span style={{ color: isDark ? '#8c8c8c' : '#666666' }}> - Ê£ÄÊµãÂà∞Á≥ªÁªüÂºÇÂ∏∏ÔºåÂèëÈÄÅÂëäË≠¶</span>
                </Timeline.Item>
                <Timeline.Item color="orange">
                  <Text strong style={{ color: isDark ? '#ffffff' : '#262626' }}>
                    14:20:15
                  </Text>
                  <span style={{ color: isDark ? '#8c8c8c' : '#666666' }}> - ‰ªªÂä°ÊâßË°åË∂ÖÊó∂ÔºåÂºÄÂßãÈáçËØï</span>
                </Timeline.Item>
                <Timeline.Item>
                  <Text strong style={{ color: isDark ? '#ffffff' : '#262626' }}>
                    14:15:00
                  </Text>
                  <span style={{ color: isDark ? '#8c8c8c' : '#666666' }}> - Êô∫ËÉΩ‰ΩìÈÖçÁΩÆÊõ¥Êñ∞</span>
                </Timeline.Item>
              </Timeline>
            </div>
          </div>
        )}
      </Modal>
    </PageContainer>
  );
};

export default AIAgentManagement;
